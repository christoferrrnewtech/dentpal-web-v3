import React, { useCallback, useEffect, useMemo, useRef, useState } from 'react';
import { InventoryItem } from './types';
import { useInventory } from './hooks';
import InventoryAdjustForm from './InventoryAdjustForm';
import InventoryTable from './InventoryTable';
import HistoryFilters from './HistoryFilters';
import HistoryTable from './HistoryTable';
import ListingTable from './ListingTable';
import StockoutTable from './StockoutTable';
import ActiveTable from './ActiveTable';
import StatusFilters from './StatusFilters';
import { InventoryService } from '../../services/inventory';
import { useAuth } from '@/hooks/use-auth';
import { getWebUsers } from '@/services/webUserService';
import { useToast } from '@/hooks/use-toast';
import { storage, auth } from '@/lib/firebase';
import { ref as storageRef, uploadBytes, getDownloadURL } from 'firebase/storage';
import { ProductService } from '@/services/product';
import CategoryService from '@/services/category';
import CatalogTable from './CatalogTable';
import { CalendarClock, Package, AlertTriangle, CircleSlash, CheckCircle2, Search, X, FolderTree, ShieldCheck, CreditCard, ChevronDown, ChevronRight, Plus, Edit } from 'lucide-react';
import { useNavigate, useLocation } from 'react-router-dom';
import DateRangePicker from '@/components/ui/DateRangePicker';

// Category and subcategory options
const CATEGORY_OPTIONS = ['Consumables', 'Dental Equipment', 'Disposables', 'Equipment'] as const;
const SUBCATEGORY_OPTIONS: Record<typeof CATEGORY_OPTIONS[number], string[]> = {
  Consumables: [
    'Bonding Agents',
    'Cements',
    'Cleaning Solutions',
    'Endodontic materials',
    'Fillings',
    'Impression materials',
    'Orthodontic Materials',
    'Polishing Agents',
    'Restorative materials',
    'Sealants',
    'Temporary materials',
  ],
  'Dental Equipment': ['Tools'],
  Disposables: ['Clinical Waste', 'Instrument and Tools', 'Patient Care Items', 'Protective Wear'],
  Equipment: [
    'Curing light',
    'Dental Chairs and Units',
    'Diagnostic Equipment',
    'Handpieces and Tools',
    'Impression Equipment',
    'Orthodontic Equipments',
    'Prosthodentics Equipments',
    'Sterilization Equipment',
    'Ultrasonic Cleaners',
  ],
};

  // TODO: replace with real Category IDs when available
const CATEGORY_NAME_TO_ID: Record<string, string> = {
  'Disposables': 'EsDNnmc72LZNMHk3SmeV',
  'Dental Equipment': 'PtqCTLGduo6vay2umpMY',
  'Consumables': 'iXMJ7vcFIcMjQBVfIHZp',
  'Equipment': 'z5BRrsDIy92XEK1PzdM4',
  'Equipments': 'z5BRrsDIy92XEK1PzdM4',
};

const SUBCATEGORY_NAME_TO_ID: Record<string, string> = {
  // TODO: replace with real subcategory IDs when available
  'Bonding Agents': 'OEtF1TsohK0Re8RT9rOf',
};

type ItemStatus = 'active' | 'inactive' | 'draft' | 'pending_qc' | 'violation' | 'deleted';

interface InventoryTabProps {
  sellerId?: string; 
  initialTab?: 'add' | 'history' | 'active' | 'stockout' | 'listing' | 'all' | 'price' | 'item-management';
}

const mockItems: InventoryItem[] = [
  { id: 'it-1', name: 'Alginate Powder', suggestedThreshold: 5, inStock: 12, unit: 'bag', updatedAt: Date.now() - 86400000 },
  { id: 'it-2', name: 'Impression Tray Size M', suggestedThreshold: 20, inStock: 18, unit: 'pcs', updatedAt: Date.now() - 3600000 },
  { id: 'it-3', name: 'Composite A2', suggestedThreshold: 10, inStock: 7, unit: 'syringe', updatedAt: Date.now() - 7200000 },
];

const InventoryTab: React.FC<InventoryTabProps> = ({ sellerId, initialTab = 'listing' }) => {
  const [items, setItems] = useState<InventoryItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [categoryMap, setCategoryMap] = useState<Record<string, string>>({});
  const categoriesList = useMemo(() => {
    return Object.entries(categoryMap)
      .map(([id, name]) => ({ id, name }))
      .sort((a, b) => a.name.localeCompare(b.name));
  }, [categoryMap]);
  const { filtered, query, setQuery, draft, selectItem, setDelta, setReason, resetDraft } = useInventory(items);
  const [submitting, setSubmitting] = useState(false);
  
  // Internal tab state for Inventory Control sub-tabs
  const [inventoryControlTab, setInventoryControlTab] = useState<'all' | 'history' | 'stock-adjustment' | 'price-management' | 'item-management'>(() => {
    // Map initialTab to inventory control tabs
    if (initialTab === 'all' || initialTab === 'listing') return 'all';
    if (initialTab === 'history') return 'history';
    if (initialTab === 'add') return 'stock-adjustment';
    if (initialTab === 'price') return 'price-management';
    if (initialTab === 'item-management') return 'item-management';
    return 'all';
  });
  
  // Derive view flags from internal tab state
  const showHistoryView = inventoryControlTab === 'history';
  const showStockAdjustmentView = inventoryControlTab === 'stock-adjustment';
  const showPriceManagementView = inventoryControlTab === 'price-management';
  const showItemManagementView = inventoryControlTab === 'item-management';
  const showAllView = inventoryControlTab === 'all';
  const [catalogTab, setCatalogTab] = useState<'all' | 'active' | 'inactive' | 'draft' | 'pending_qc' | 'violation' | 'deleted'>('all');
  const [filterName, setFilterName] = useState<string>('');
  const [filterCategory, setFilterCategory] = useState<string>('');
  const [sortBy, setSortBy] = useState<'name' | 'stock' | 'updatedAt'>('name');

  const [history, setHistory] = useState<Array<{ id: string; adjustmentNo: string; dateISO: string; reason: string; itemName: string; stockAfter: number }>>([]);
  const [historyDate, setHistoryDate] = useState<string>('');
  const [historyReason, setHistoryReason] = useState<string>('');

  // New: Logs state
  const [logs, setLogs] = useState<Array<any>>([]);
  const [logsLoading, setLogsLoading] = useState(false);
  const [logsDateRange, setLogsDateRange] = useState<{ start: Date | null; end: Date | null }>(() => {
    // Default to last 30 days including today
    const end = new Date();
    const start = new Date();
    start.setDate(start.getDate() - 30);
    return { start, end };
  });
  const [logsActionFilter, setLogsActionFilter] = useState<string>('all');
  const [logsProductSearch, setLogsProductSearch] = useState<string>('');
  const [logsPage, setLogsPage] = useState<number>(1);
  const logsPerPage = 50;

  const { uid, isSeller, isAdmin } = useAuth();
  const { toast } = useToast();
  const navigate = useNavigate();
  const location = useLocation();

 
  const fileInputRef = useRef<HTMLInputElement | null>(null);

  const [sellers, setSellers] = useState<Array<{ uid: string; name?: string; email: string }>>([]);
  const [selectedSellerId, setSelectedSellerId] = useState<string | null>(null);

  const [lowOnly, setLowOnly] = useState<boolean>(false);
  const { isSubAccount, parentId } = useAuth();
  const effectiveSellerId = sellerId ?? (isSeller ? (isSubAccount ? (parentId || uid) : uid) : selectedSellerId);

  

  // New item state
  const [showAdd, setShowAdd] = useState(false);
  const [newItem, setNewItem] = useState<{
    name: string;
    description: string;
    imageUrl: string; 
    imageFile?: File | null;
    imagePreview?: string | null;
    category: string;
    subcategory: string;
    price: number;
    specialPrice: number;
    sku: string;
    weight: number;
    dimensions: { length: number; width: number; height: number };
    suggestedThreshold: number;
    unit: string;
    inStock: number;
    simpleVariantName?: string;
  }>({
    name: '',
    description: '',
    imageUrl: '',
    imageFile: null,
    imagePreview: null,
    category: '',
    subcategory: '',
    price: 0,
    specialPrice: 0,
    sku: '',
    weight: 0,
    dimensions: { length: 0, width: 0, height: 0 },
    suggestedThreshold: 0,
    unit: '',
    inStock: 0,
    simpleVariantName: '',
  });
  const resetNewItem = () => setNewItem({
    name: '', description: '', imageUrl: '', imageFile: null, imagePreview: null, category: '', subcategory: '', price: 0, specialPrice: 0, sku: '', weight: 0,
    dimensions: { length: 0, width: 0, height: 0 }, suggestedThreshold: 0, unit: '', inStock: 0,
    simpleVariantName: '',
  });

  const [available, setAvailable] = useState<boolean>(true);
  const [preOrder, setPreOrder] = useState<boolean>(false);

  const [variants, setVariants] = useState<Array<{ key: string; options: Record<string, string>; price: number; stock: number; sku?: string; specialPrice?: number; available?: boolean; isFragile?: boolean; imageUrl?: string; imageFile?: File | null; imagePreview?: string | null; name?: string }>>([]);
  const variantFileInputs = useRef<Record<string, HTMLInputElement | null>>({});
  const [pendingVariantPick, setPendingVariantPick] = useState<string | null>(null);

  const triggerVariantFilePick = (key: string) => {
    if (!variantFileInputs.current[key]) return;
    variantFileInputs.current[key]!.click();
  };

  useEffect(() => {
    if (!pendingVariantPick) return;
    const el = variantFileInputs.current[pendingVariantPick];
    if (el) {
      el.click();
      setPendingVariantPick(null);
    }
  }, [variants, pendingVariantPick]);

  const handleVariantFileChange = async (key: string, e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const preview = URL.createObjectURL(file);
    setVariants((list) => list.map(v => {
      if (v.key !== key) return v;
      if (v.imagePreview) URL.revokeObjectURL(v.imagePreview);
      return { ...v, imageFile: file, imagePreview: preview };
    }));
    if (variantFileInputs.current[key]) variantFileInputs.current[key]!.value = '';
  };

  const addBlankVariant = () => {
    const key = `manual-${Date.now()}-${Math.random().toString(36).slice(2, 7)}`;
    setVariants((prev) => [...prev, { key, options: {}, price: 0, stock: 0, sku: undefined, specialPrice: 0, available: true, isFragile: false, imageUrl: undefined, imageFile: null, imagePreview: null, name: '' }]);
    setPendingVariantPick(key);
  };

  // Price Management states
  const [priceFilterName, setPriceFilterName] = useState<string>('');
  const [priceFilterCategory, setPriceFilterCategory] = useState<string>('');
  const [priceSortBy, setPriceSortBy] = useState<'name' | 'price' | 'priceAsc' | 'updatedAt'>('name');
  
  // Price Management Modal states
  const [showPriceModal, setShowPriceModal] = useState(false);
  const [pricingProduct, setPricingProduct] = useState<string | null>(null);
  const [pricingVariation, setPricingVariation] = useState<any>(null);
  const [priceForm, setPriceForm] = useState<{
    currentPrice: number;
    newPrice: number | '';
    specialPrice: number | '';
    price?: number | '';
    promoMode?: 'long' | 'dated';
    start?: string;
    end?: string;
  }>({
    currentPrice: 0,
    newPrice: '',
    specialPrice: '',
  });
  
  const [priceRows, setPriceRows] = useState<Array<{
    productId: string;
    price: number | '';
    specialPrice: number | '';
  }>>([]);

  // Item Management states
  const [itemMgmtFilterName, setItemMgmtFilterName] = useState<string>('');
  const [itemMgmtFilterCategory, setItemMgmtFilterCategory] = useState<string>('');
  const [itemMgmtSortBy, setItemMgmtSortBy] = useState<'name' | 'price' | 'stock' | 'updatedAt'>('name');
  const [showEditModal, setShowEditModal] = useState<boolean>(false);
  const [editingItem, setEditingItem] = useState<string | null>(null);
  const [editForm, setEditForm] = useState<{
    name: string;
    description: string;
    categoryID: string;
    subCategoryID: string;
    price: number;
    specialPrice: number | '';
    inStock: number;
    suggestedThreshold: number;
    lowestPrice: number | '';
    imageURL: string;
    imageFile?: File | null;
    imagePreview?: string | null;
    status: 'active' | 'inactive' | 'draft' | 'pending_qc' | 'violation' | 'deleted';
    dangerousGoods: 'none' | 'dangerous';
    warrantyType: string;
    warrantyDuration: string;
    promoStart: number | null;
    promoEnd: number | null;
    variations: Array<{
      id?: string;
      name: string;
      SKU: string;
      price: number;
      stock: number;
      imageURL: string;
      imageFile?: File | null;
      imagePreview?: string | null;
      weight: number | '';
      weightUnit: string;
      dimensions: { length: number | ''; width: number | ''; height: number | '' };
      dimensionsUnit: string;
      isFragile?: boolean;
      isNew?: boolean;
      isDeleted?: boolean;
    }>;
  } | null>(null);
  const [subcategoryOptions, setSubcategoryOptions] = useState<Array<{ id: string; name: string }>>([]);
  const editImageInputRef = useRef<HTMLInputElement | null>(null);
  const variationImageInputRefs = useRef<Record<number, HTMLInputElement | null>>({});
  
  // Variation management states
  const [expandedProducts, setExpandedProducts] = useState<Set<string>>(new Set());
  const [productVariations, setProductVariations] = useState<Record<string, Array<any>>>({});
  const [loadingVariations, setLoadingVariations] = useState<Set<string>>(new Set());

  useEffect(() => {
    let mounted = true;
    (async () => {
      if (!isAdmin) return;
      try {
        const rows = await getWebUsers(['seller' as any]);
        if (!mounted) return;
        const mapped = rows.map(u => ({ uid: (u as any).uid, name: (u as any).name, email: (u as any).email }));
        setSellers(mapped);
        if (!selectedSellerId && mapped.length > 0) {
          setSelectedSellerId(mapped[0].uid);
        }
      } catch (e) {
        console.error('Failed to load sellers', e);
        toast({ title: 'Failed to load sellers', description: 'Please try again later.' });
      }
    })();
    return () => { mounted = false; };
  }, [isAdmin]);

  // Load categories from Firebase to create ID to name mapping
  useEffect(() => {
    const unsub = CategoryService.listenCategories((categories) => {
      const map: Record<string, string> = {};
      categories.forEach(cat => {
        map[cat.id] = cat.name;
      });
      setCategoryMap(map);
    });
    return () => unsub();
  }, []);

  useEffect(() => {
    if (!effectiveSellerId) {
      setItems([]);
      setLoading(false);
      return;
    }
    setLoading(true);
    const unsub = ProductService.listenBySeller(effectiveSellerId, (rows) => {
      const mapped = rows.map(r => ({
        id: r.id,
        name: r.name,
        suggestedThreshold: r.suggestedThreshold != null ? Number(r.suggestedThreshold) : 5,
        inStock: r.inStock,
        unit: undefined,
        updatedAt: r.updatedAt,
        description: r.description || '',
        imageUrl: r.imageUrl,
        category: r.category || r.categoryID, // Store categoryID, will map to name in useMemo
        categoryID: r.categoryID,
        subcategory: r.subcategory || r.subCategoryID,
        subCategoryID: r.subCategoryID,
        variations: [],
        price: r.price,
        specialPrice: r.specialPrice,
        status: r.status,
        isActive: r.isActive != null ? !!r.isActive : (r.status === 'active'),
        sku: undefined,
        weight: undefined,
        dimensions: undefined,
        available: true,
        preOrder: false,
        hasVariants: true,
        variants: [],
        variationCount: r.variationCount || 0,
      }));
      setItems(mapped as any);
      setLoading(false);
    });
    return () => unsub();
  }, [effectiveSellerId]);

  // Enrich items with category names from categoryMap
  const enrichedItems = useMemo(() => {
    return items.map(item => ({
      ...item,
      // Ensure isActive always present; derive from status if missing
      isActive: item.isActive != null ? !!item.isActive : ((item.status as any) === 'active'),
      categoryName: categoryMap[item.category as string] || item.category || 'N/A',
    }));
  }, [items, categoryMap]);

  useEffect(() => {
    if (!effectiveSellerId) { setHistory([]); return; }
    const unsub = InventoryService.listenAdjustmentsBySeller(effectiveSellerId, (rows) => {
      setHistory(rows);
    });
    return () => unsub();
  }, [effectiveSellerId]);

  // New: Listen to product logs
  useEffect(() => {
    if (!effectiveSellerId) { setLogs([]); setLogsLoading(false); return; }
    setLogsLoading(true);
    const unsub = ProductService.listenProductLogsBySeller(
      effectiveSellerId, 
      (rows) => {
        setLogs(rows);
        setLogsLoading(false);
      },
      { 
        startDate: logsDateRange.start, 
        endDate: logsDateRange.end 
      }
    );
    return () => unsub();
  }, [effectiveSellerId, logsDateRange.start, logsDateRange.end]);

  // Auto-open edit form if editId is in URL params
  useEffect(() => {
    if (showItemManagementView) {
      const params = new URLSearchParams(location.search);
      const editId = params.get('editId');
      if (editId) {
        // Auto-open the edit form for this product
        openEdit(editId);
        // Clean up the URL parameter
        const newParams = new URLSearchParams(location.search);
        newParams.delete('editId');
        navigate(`${location.pathname}?${newParams.toString()}`, { replace: true });
      }
    }
  }, [showItemManagementView, location.search]);

  const handleSubmit = useCallback(async () => {
    if (!draft.itemId || !draft.reason || draft.delta === 0) return;
    try {
      setSubmitting(true);
      await InventoryService.adjustStock(draft.itemId, draft.delta, draft.reason);
      resetDraft();
      toast({ title: 'Stock updated', description: 'Your stock adjustment has been recorded.' });
    } catch (e) {
      console.error('Adjust stock failed', e);
      toast({ title: 'Failed to adjust stock', description: 'Please try again.' });
    } finally {
      setSubmitting(false);
    }
  }, [draft, resetDraft]);

  const handleCreateItem = useCallback(async (createStatus?: ItemStatus) => {
    if (!effectiveSellerId) {
      toast({ title: 'Select a seller first', description: 'Choose a seller to create items under.' });
      return;
    }
    if (!newItem.name.trim()) {
      toast({ title: 'Name is required' });
      return;
    }
    try {
      setSubmitting(true);

      let productImageUrl: string | undefined = newItem.imageUrl?.trim() || undefined;
      let imageVersion: string | null = null;
      if (newItem.imageFile) {
        const ts = Date.now().toString();
        const safeName = encodeURIComponent(newItem.imageFile.name);
        const p = `ProductImages/${ts}/${safeName}`;
        const r = storageRef(storage, p);
        await uploadBytes(r, newItem.imageFile);
        productImageUrl = await getDownloadURL(r);
        imageVersion = ts;
      }

      const variationImageVersions: Record<string, string> = {};
      const variantsToSave = [] as Array<{ key: string; options: Record<string, string>; price: number; stock: number; sku?: string; specialPrice?: number; available?: boolean; isFragile?: boolean; imageUrl?: string; name?: string }>;
      for (let idx = 0; idx < variants.length; idx++) {
        const v = variants[idx];
        let vUrl = v.imageUrl;
        if (v.imageFile) {
          const ts = Date.now().toString();
          const safeV = encodeURIComponent(v.imageFile.name);
          const path = `ProductImages/${effectiveSellerId}/variants/${ts}_${safeV}`;
          const ref = storageRef(storage, path);
          await uploadBytes(ref, v.imageFile);
          vUrl = await getDownloadURL(ref);
          variationImageVersions[String(idx)] = ts;
        }
        variantsToSave.push({ key: v.key, options: v.options, price: Number(v.price) || 0, stock: Number(v.stock) || 0, sku: v.sku, specialPrice: v.specialPrice, available: v.available, isFragile: v.isFragile, imageUrl: vUrl, name: (v.name || '').trim() || undefined });
      }

      const lowestPrice = variantsToSave.length > 0
        ? Math.min(...variantsToSave.map(v => (v.specialPrice != null && v.specialPrice > 0 ? Number(v.specialPrice) : Number(v.price)) || 0))
        : (newItem.specialPrice && newItem.specialPrice > 0 ? Number(newItem.specialPrice) : Number(newItem.price) || 0);

      const productRef = await ProductService.createProduct({
        sellerId: effectiveSellerId!,
        name: newItem.name.trim(),
        description: newItem.description.trim(),
        imageURL: productImageUrl || '',
        imageVersion,
        categoryID: CATEGORY_NAME_TO_ID[newItem.category] || null,
        subCategoryID: SUBCATEGORY_NAME_TO_ID[newItem.subcategory] || null,
        isActive: createStatus === 'draft' ? false : true,
        status: createStatus === 'draft' ? 'draft' : undefined,
        clickCounter: 0,
        lowestPrice,
        variationImageVersions,
        suggestedThreshold: newItem.suggestedThreshold > 0 ? newItem.suggestedThreshold : null,
      } as any);

      const variationsForProduct = (variantsToSave.length > 0)
        ? variantsToSave.map((v, i) => ({
            sku: v.sku,
            price: v.specialPrice != null && v.specialPrice > 0 ? Number(v.specialPrice) : Number(v.price),
            stock: v.stock,
            weight: newItem.weight || undefined,
            dimensions: newItem.dimensions || undefined,
            imageURL: v.imageUrl || null,
            name: v.name?.trim() || `batch${i}`,
            isFragile: v.isFragile ?? false,
          }))
        : [{
            sku: newItem.sku || undefined,
            price: (newItem.specialPrice && newItem.specialPrice > 0 ? Number(newItem.specialPrice) : Number(newItem.price) || 0),
            stock: Number(newItem.inStock) || 0,
            weight: newItem.weight || undefined,
            dimensions: newItem.dimensions || undefined,
            imageURL: productImageUrl || null,
            name: (newItem.simpleVariantName || '').trim() || 'default',
            isFragile: false,
          }];

      await ProductService.addVariations(productRef.id, variationsForProduct);

      if (newItem.imagePreview) URL.revokeObjectURL(newItem.imagePreview);
      variants.forEach(v => { if (v.imagePreview) URL.revokeObjectURL(v.imagePreview); });

      setShowAdd(false);
      resetNewItem();
      setVariants([]);
      // Navigate to "All" view after creating product
      setInventoryControlTab('all');
      if (createStatus === 'draft') {
        setCatalogTab('draft');
        toast({ title: 'Draft saved', description: `${newItem.name} has been saved as a draft.` });
      } else {
        toast({ title: 'Product created', description: `${newItem.name} has been added to catalog.` });
      }
    } catch (e) {
      console.error('Create item failed', e);
      toast({ title: 'Failed to create product', description: 'Please try again.' });
    } finally {
      setSubmitting(false);
    }
  }, [newItem, effectiveSellerId, variants, available, preOrder]);

  const handlePickImage = () => {
    fileInputRef.current?.click();
  };

  const handleFileChange: React.ChangeEventHandler<HTMLInputElement> = async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const preview = URL.createObjectURL(file);
    setNewItem((s) => {
      if (s.imagePreview) URL.revokeObjectURL(s.imagePreview);
      return { ...s, imageFile: file, imagePreview: preview };
    });
    if (fileInputRef.current) fileInputRef.current.value = '';
  };

  const filteredCatalog = useMemo(() => {
    const nameQuery = (filterName || '').trim().toLowerCase();
    return enrichedItems
      .filter(i => {
        const status = (i.status ?? 'active');
        if (catalogTab === 'all') return true;
        if (catalogTab === 'pending_qc') return status === 'pending_qc';
        return status === catalogTab;
      })
      .filter(i => {
        if (!nameQuery) return true;
        const n = (i.name || '').toLowerCase();
        const s = (i.sku || '').toLowerCase();
        return n.includes(nameQuery) || s.includes(nameQuery);
      })
      .filter(i => {
        if (!filterCategory) return true;
        return i.categoryName === filterCategory;
      })
      .filter(i => {
        if (!lowOnly) return true;
        const thr = Number(i.suggestedThreshold ?? 5);
        const stock = Number(i.inStock || 0);
        return stock === 0 || (thr > 0 && stock > 0 && stock <= thr);
      })
      .sort((a, b) => {
        if (sortBy === 'stock') {
          const diff = (Number(b.inStock || 0) - Number(a.inStock || 0));
          if (diff !== 0) return diff;
          return (a.name || '').localeCompare(b.name || '');
        }
        if ((sortBy as any) === 'stockAsc') {
          const diff = (Number(a.inStock || 0) - Number(b.inStock || 0));
          if (diff !== 0) return diff;
          return (a.name || '').localeCompare(b.name || '');
        }
        if (sortBy === 'updatedAt') {
          const diff = (Number(b.updatedAt || 0) - Number(a.updatedAt || 0));
          if (diff !== 0) return diff;
          return (a.name || '').localeCompare(b.name || '');
        }
        return (a.name || '').localeCompare(b.name || '');
      });
  }, [enrichedItems, catalogTab, filterName, filterCategory, sortBy, lowOnly]);

  // Filter and paginate logs (date range is now handled by Firebase query)
  const filteredLogs = useMemo(() => {
    let filtered = logs;

    // Action type filter
    if (logsActionFilter !== 'all') {
      filtered = filtered.filter(log => log.action === logsActionFilter);
    }

    // Product name search
    if (logsProductSearch.trim()) {
      const search = logsProductSearch.toLowerCase();
      filtered = filtered.filter(log => 
        (log.productName || '').toLowerCase().includes(search)
      );
    }

    return filtered;
  }, [logs, logsActionFilter, logsProductSearch]);

  const paginatedLogs = useMemo(() => {
    const start = (logsPage - 1) * logsPerPage;
    const end = start + logsPerPage;
    return filteredLogs.slice(start, end);
  }, [filteredLogs, logsPage, logsPerPage]);

  const totalLogsPages = Math.ceil(filteredLogs.length / logsPerPage);

  const exportLogs = useCallback(() => {
    if (filteredLogs.length === 0) {
      toast({ title: 'No data to export', description: 'There are no logs matching your filters.' });
      return;
    }

    const headers = ['Timestamp', 'Item Name', 'Variant', 'Account Name', 'Reason', 'Adjustment', 'Stock After'];
    const rows = filteredLogs.map(log => {
      const timestamp = log.at ? new Date(log.at).toLocaleString() : 'N/A';
      const itemName = log.productName || 'Unknown';
      const variant = log.before?.variationName || log.after?.variationName || 'N/A';
      const accountName = log.userName || log.userId || 'Unknown';
      const reason = log.detail || 'N/A';
      const adjustment = log.action === 'adjust_stock' 
        ? `${(log.after?.stock || 0) - (log.before?.stock || 0) >= 0 ? '+' : ''}${(log.after?.stock || 0) - (log.before?.stock || 0)}`
        : 'N/A';
      const stockAfter = log.action === 'adjust_stock' ? (log.after?.stock || 0) : 'N/A';
      
      return [timestamp, itemName, variant, accountName, reason, adjustment, stockAfter];
    });

    const csvContent = [
      headers.map(h => `"${h}"`).join(','),
      ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `inventory-history-${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
    toast({ title: 'Export successful', description: 'Inventory history has been exported.' });
  }, [filteredLogs, toast]);

  const [editingId, setEditingId] = useState<string | null>(null);

  const openEdit = useCallback(async (id: string) => {
    setSubmitting(true);
    try {
      const detail = await ProductService.getProductDetail(id);
      if (!detail) { setSubmitting(false); return; }
      const p: any = detail.product;
      const vars: any[] = Array.isArray(detail.variations) ? detail.variations : [];

      setNewItem({
        name: String(p.name || ''),
        description: String(p.description || ''),
        imageUrl: String(p.imageURL || ''),
        imageFile: null,
        imagePreview: null,
        category: '', 
        subcategory: '', 
        price: Number(p.price ?? 0) || 0,
        specialPrice: Number(p.specialPrice ?? 0) || 0,
        sku: '',
        // Take weight/dimensions from first variation if present
        weight: vars.length ? Number(vars[0].weight || vars[0]?.dimension?.weight || 0) : 0,
        dimensions: {
          length: Number(vars[0]?.dimensions?.length || 0),
          width: Number(vars[0]?.dimensions?.width || 0),
          height: Number(vars[0]?.dimensions?.height || 0),
        },
        suggestedThreshold: Number(p.suggestedThreshold ?? 5),
        unit: '',
        inStock: vars.reduce((sum, v: any) => sum + (Number(v.stock || 0)), 0),
      });

      setVariants(vars.map((v: any, i: number) => ({
        key: v.id || `var-${i}`,
        options: {},
        price: Number(v.price || 0),
        stock: Number(v.stock || 0),
        sku: v.sku || v.SKU || undefined,
        specialPrice: undefined, 
        available: true,
        isFragile: v.isFragile ?? false,
        imageUrl: v.imageURL || undefined,
        imageFile: null,
        imagePreview: null,
        name: typeof v.name === 'string' ? v.name : '',
      })));

      setAvailable(true);
      setPreOrder(false);
      setEditingId(id);
      setShowAdd(true);
    } catch (e) {
      console.error('Open edit failed', e);
    } finally {
      setSubmitting(false);
    }
  }, []);

  const openAddNew = useCallback(() => {
    if (newItem.imagePreview) URL.revokeObjectURL(newItem.imagePreview);
    variants.forEach(v => { if (v.imagePreview) URL.revokeObjectURL(v.imagePreview); });
    setEditingId(null);
    resetNewItem();
    setVariants([]);
    setAvailable(true);
    setPreOrder(false);
    setShowAdd(true);
  }, [newItem.imagePreview, variants]);

  const handleSaveItem = useCallback(async (statusOverride?: ItemStatus) => {
    if (!effectiveSellerId) {
      toast({ title: 'Select a seller first', description: 'Choose a seller to save items under.' });
      return;
    }
    if (!newItem.name.trim()) {
      toast({ title: 'Name is required' });
      return;
    }
    try {
      setSubmitting(true);

      let productImageUrl: string | undefined = newItem.imageUrl?.trim() || undefined;
      let imageVersion: string | null = null;
      if (newItem.imageFile) {
        const ts = Date.now().toString();
        const safeName = encodeURIComponent(newItem.imageFile.name);
        const p = `ProductImages/${ts}/${safeName}`;
        const r = storageRef(storage, p);
        await uploadBytes(r, newItem.imageFile);
        productImageUrl = await getDownloadURL(r);
        imageVersion = ts;
      }

      const variantsToSave = [] as Array<{ key: string; options: Record<string, string>; price: number; stock: number; sku?: string; specialPrice?: number; available?: boolean; imageUrl?: string; name?: string }>;
      for (let idx = 0; idx < variants.length; idx++) {
        const v = variants[idx];
        let vUrl = v.imageUrl;
        if (v.imageFile) {
          const ts = Date.now().toString();
          const safeV = encodeURIComponent(v.imageFile.name);
          const path = `ProductImages/${effectiveSellerId}/variants/${ts}_${safeV}`;
          const ref = storageRef(storage, path);
          await uploadBytes(ref, v.imageFile);
          vUrl = await getDownloadURL(ref);
        }
        variantsToSave.push({ key: v.key, options: v.options, price: Number(v.price) || 0, stock: Number(v.stock) || 0, sku: v.sku, specialPrice: v.specialPrice, available: v.available, imageUrl: vUrl, name: v.name?.trim() || undefined });
      }

      if (editingId) {
        await ProductService.updateProduct(editingId, {
          name: newItem.name.trim(),
          description: newItem.description.trim(),
          ...(productImageUrl !== undefined ? { imageURL: productImageUrl } : {} as any),
          ...(statusOverride ? { status: statusOverride } : {} as any),
          suggestedThreshold: newItem.suggestedThreshold > 0 ? newItem.suggestedThreshold : null,
        });
      } else {
        await handleCreateItem(statusOverride);
        return;
      }

      if (newItem.imagePreview) URL.revokeObjectURL(newItem.imagePreview);
      variants.forEach(v => { if (v.imagePreview) URL.revokeObjectURL(v.imagePreview); });

      setShowAdd(false);
      setEditingId(null);
      resetNewItem();
      setVariants([]);
      if (statusOverride === 'draft') setCatalogTab('draft');
      toast({ title: 'Product updated', description: `${newItem.name} has been updated.` });
    } catch (e) {
      console.error('Save item failed', e);
      toast({ title: 'Failed to save product', description: 'Please try again.' });
    } finally {
      setSubmitting(false);
    }
  }, [newItem, effectiveSellerId, variants, available, preOrder, editingId]);

  const statusCounts = useMemo(() => {
    const counts = { active: 0, inactive: 0, draft: 0, pending_qc: 0, violation: 0, deleted: 0 } as const;
    const acc: Record<keyof typeof counts, number> = { active: 0, inactive: 0, draft: 0, pending_qc: 0, violation: 0, deleted: 0 };
    items.forEach((i) => {
      const s = (i.status ?? 'active') as keyof typeof counts;
      if (s in acc) acc[s] += 1;
    });
    return acc;
  }, [items]);

  const stockSummary = useMemo(() => {
    let low = 0, out = 0;
    items.forEach(i => {
      const status = (i.status ?? 'active');
      if (status === 'deleted') return;
      const thr = Number(i.suggestedThreshold ?? 5);
      const stock = Number(i.inStock || 0);
      if (stock === 0) out += 1; else if (thr > 0 && stock <= thr) low += 1;
    });
    return { low, out };
  }, [items]);

  const [priceDialogOpen, setPriceDialogOpen] = useState(false);
  const [priceEditingItem, setPriceEditingItem] = useState<InventoryItem | null>(null);

  const [stockDialogOpen, setStockDialogOpen] = useState(false);
  const [stockEditingItem, setStockEditingItem] = useState<InventoryItem | null>(null);
  const [stockForm, setStockForm] = useState<{ delta: number | ''; reason: string; variationId?: string }>(() => ({ delta: '', reason: '' }));
  const [stockVariations, setStockVariations] = useState<Array<{ id: string; name?: string | null; stock: number }>>([]);
  const [stockRows, setStockRows] = useState<Array<{ id: string; name?: string | null; stock: number; delta: number | ''; reason: string }>>([]);

  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [deleteTarget, setDeleteTarget] = useState<InventoryItem | null>(null);

  const openPriceDialog = (item: InventoryItem) => {
    setPriceEditingItem(item);
    setPriceForm({
      price: Number(item.price ?? 0) || 0,
      specialPrice: Number(item.specialPrice ?? 0) || 0,
      promoMode: item?.promoStart && item?.promoEnd ? 'dated' : 'long',
      start: item?.promoStart ? new Date(item.promoStart).toISOString().slice(0,10) : undefined,
      end: item?.promoEnd ? new Date(item.promoEnd).toISOString().slice(0,10) : undefined,
    });
    setPriceDialogOpen(true);
  };

  const savePriceDialog = async () => {
    if (!priceEditingItem) return;
    try {
      setSubmitting(true);
      const payload: any = {
        price: priceForm.price === '' ? null : Number(priceForm.price),
        specialPrice: priceForm.specialPrice === '' ? null : Number(priceForm.specialPrice),
        promoStart: null as number | null,
        promoEnd: null as number | null,
      };
      if (priceForm.promoMode === 'dated') {
        const startMs = priceForm.start ? new Date(priceForm.start + 'T00:00:00').getTime() : null;
        const endMs = priceForm.end ? new Date(priceForm.end + 'T23:59:59').getTime() : null;
        payload.promoStart = startMs;
        payload.promoEnd = endMs;
      }
      await ProductService.updatePriceAndPromo(priceEditingItem.id, payload, uid || undefined, auth.currentUser?.email || undefined);
      setPriceDialogOpen(false);
      setPriceEditingItem(null);
      toast({ title: 'Price updated', description: 'The product pricing has been saved.' });
    } catch (e) {
      console.error('Update price failed', e);
      toast({ title: 'Failed to update price', description: 'Please try again.' });
    } finally {
      setSubmitting(false);
    }
  };

  const openStockDialog = async (item: InventoryItem) => {
    setStockEditingItem(item);
    setStockForm({ delta: '', reason: '', variationId: undefined });
    try {
      let vars = await ProductService.getVariations(item.id);

      if (!vars || vars.length === 0) {
        try {
          const vid = await ProductService.ensureDefaultVariation(item.id);
          vars = [{ id: vid, name: 'default', stock: 0 } as any];
        } catch (e) {
          console.error('ensureDefaultVariation failed', e);
        }
      }

      const normalized = vars.map((v: any) => ({ id: v.id, name: v.name ?? '', stock: Number(v.stock ?? 0) }));
      setStockVariations(normalized);
      setStockRows(normalized.map(v => ({ id: v.id, name: v.name, stock: v.stock, delta: '', reason: '' })));
    } catch (e) {
      console.error('Failed to load variations', e);
      setStockVariations([]);
      setStockRows([]);
    }
    setStockDialogOpen(true);
  };

  const saveStockDialog = async () => {
    if (!stockEditingItem) return;
    try {
      setSubmitting(true);
      const tasks = stockRows
        .filter(r => r.delta !== '' && Number(r.delta) !== 0 && r.reason)
        .map(r => ProductService.adjustVariationStock(stockEditingItem.id, r.id, Number(r.delta), uid || undefined, auth.currentUser?.email || undefined));

      if (tasks.length === 0) {
        toast({ title: 'No changes', description: 'Enter a delta and reason for at least one variation.' });
        return;
      }

      await Promise.all(tasks);
      setStockDialogOpen(false);
      setStockEditingItem(null);
      toast({ title: 'Stock updated', description: `${tasks.length} variation${tasks.length > 1 ? 's' : ''} adjusted.` });
    } catch (e) {
      console.error('Adjust stock failed', e);
      toast({ title: 'Failed to adjust stock', description: 'Please try again.' });
    } finally {
      setSubmitting(false);
    }
  };

  const openDeleteDialog = (item: InventoryItem) => {
    setDeleteTarget(item);
    setDeleteDialogOpen(true);
  };

  // Stock Adjustment state - Table-based approach
  const [adjustmentFilterName, setAdjustmentFilterName] = useState('');
  const [adjustmentFilterCategory, setAdjustmentFilterCategory] = useState('');
  const [adjustmentSortBy, setAdjustmentSortBy] = useState<'name' | 'stock' | 'stockAsc' | 'updatedAt'>('name');
  const [adjustmentLowOnly, setAdjustmentLowOnly] = useState(false);
  
  // Stock Adjustment Modal states
  const [showAdjustmentModal, setShowAdjustmentModal] = useState(false);
  const [adjustingProduct, setAdjustingProduct] = useState<string | null>(null);
  const [adjustingVariation, setAdjustingVariation] = useState<any>(null);
  const [adjustmentForm, setAdjustmentForm] = useState<{
    reason: 'Inventory Count' | 'Loss' | 'Damaged' | '';
    notes: string;
    expectedStock?: number;
    countedStock?: number;
    removeStock?: number;
  }>({
    reason: '',
    notes: '',
    expectedStock: 0,
    countedStock: 0,
    removeStock: 0,
  });
  
  // Table rows for adjustments (legacy - will be removed)
  const [adjustmentRows, setAdjustmentRows] = useState<Array<{
    productId: string;
    reason: 'Inventory Count' | 'Loss' | 'Damaged' | '';
    notes: string;
    expectedStock?: number;
    countedStock?: number;
    removeStock?: number;
  }>>([]);

  // Filtered and sorted products for stock adjustment
  const filteredAdjustmentProducts = useMemo(() => {
    let filtered = enrichedItems.filter(item => {
      if (adjustmentFilterName && !item.name.toLowerCase().includes(adjustmentFilterName.toLowerCase())) return false;
      // Compare by category ID selected from dropdown
      if (adjustmentFilterCategory && item.category !== adjustmentFilterCategory) return false;
      if (adjustmentLowOnly && item.inStock >= (item.suggestedThreshold || 5)) return false;
      return true;
    });

    // Sort
    filtered.sort((a, b) => {
      if (adjustmentSortBy === 'name') return a.name.localeCompare(b.name);
      if (adjustmentSortBy === 'stock') return b.inStock - a.inStock;
      if (adjustmentSortBy === 'stockAsc') return a.inStock - b.inStock;
      if (adjustmentSortBy === 'updatedAt') return (b.updatedAt || 0) - (a.updatedAt || 0);
      return 0;
    });

    return filtered;
  }, [enrichedItems, adjustmentFilterName, adjustmentFilterCategory, adjustmentSortBy, adjustmentLowOnly]);

  // Filtered and sorted products for price management
  const filteredPriceProducts = useMemo(() => {
    let filtered = enrichedItems.filter(item => {
      if (priceFilterName && !item.name.toLowerCase().includes(priceFilterName.toLowerCase())) return false;
      // Compare by category ID selected from dropdown
      if (priceFilterCategory && item.category !== priceFilterCategory) return false;
      return true;
    });

    // Sort
    filtered.sort((a, b) => {
      if (priceSortBy === 'name') return a.name.localeCompare(b.name);
      if (priceSortBy === 'price') return (b.price || 0) - (a.price || 0);
      if (priceSortBy === 'priceAsc') return (a.price || 0) - (b.price || 0);
      if (priceSortBy === 'updatedAt') return (b.updatedAt || 0) - (a.updatedAt || 0);
      return 0;
    });

    return filtered;
  }, [enrichedItems, priceFilterName, priceFilterCategory, priceSortBy]);

  // Filtered and sorted products for item management
  const filteredItemMgmtProducts = useMemo(() => {
    let filtered = enrichedItems.filter(item => {
      if (itemMgmtFilterName && !item.name.toLowerCase().includes(itemMgmtFilterName.toLowerCase())) return false;
      // Compare by category ID selected from dropdown
      if (itemMgmtFilterCategory && item.category !== itemMgmtFilterCategory) return false;
      return true;
    });

    // Sort
    filtered.sort((a, b) => {
      if (itemMgmtSortBy === 'name') return a.name.localeCompare(b.name);
      if (itemMgmtSortBy === 'price') return (b.price || 0) - (a.price || 0);
      if (itemMgmtSortBy === 'stock') return (b.inStock || 0) - (a.inStock || 0);
      if (itemMgmtSortBy === 'updatedAt') return (b.updatedAt || 0) - (a.updatedAt || 0);
      return 0;
    });

    return filtered;
  }, [enrichedItems, itemMgmtFilterName, itemMgmtFilterCategory, itemMgmtSortBy]);

  // Initialize adjustment rows when products change
  useEffect(() => {
    if (showStockAdjustmentView && filteredAdjustmentProducts.length > 0) {
      setAdjustmentRows(prev => {
        const existingMap = new Map(prev.map(r => [r.productId, r]));
        return filteredAdjustmentProducts.map(product => {
          const existing = existingMap.get(product.id);
          if (existing) return existing;
          return {
            productId: product.id,
            reason: '' as const,
            notes: '',
            expectedStock: product.inStock,
            countedStock: product.inStock,
            removeStock: 0,
          };
        });
      });
    }
  }, [filteredAdjustmentProducts, showStockAdjustmentView]);

  // Initialize price rows when products change
  useEffect(() => {
    if (showPriceManagementView && filteredPriceProducts.length > 0) {
      setPriceRows(prev => {
        const existingMap = new Map(prev.map(r => [r.productId, r]));
        return filteredPriceProducts.map(product => {
          const existing = existingMap.get(product.id);
          if (existing) return existing;
          return {
            productId: product.id,
            price: product.price || 0,
            specialPrice: product.specialPrice || '',
          };
        });
      });
    }
  }, [filteredPriceProducts, showPriceManagementView]);

  const handleBulkAdjustmentSubmit = async () => {
    const validRows = adjustmentRows.filter(row => row.reason && row.notes.trim());
    
    if (validRows.length === 0) {
      toast({ title: 'Validation Error', description: 'Please select a reason and add notes for at least one product', variant: 'destructive' });
      return;
    }

    try {
      setSubmitting(true);
      
      for (const row of validRows) {
        const product = items.find(i => i.id === row.productId);
        if (!product) continue;

        // Calculate delta
        let delta: number;
        if (row.reason === 'Inventory Count') {
          delta = (row.countedStock || 0) - product.inStock;
        } else {
          delta = -(row.removeStock || 0);
        }

        if (delta === 0) continue; // Skip if no change

        // Get or create variation
        let variationId: string;
        try {
          const vars = await ProductService.getVariations(row.productId);
          if (vars && vars.length > 0) {
            variationId = vars[0].id;
          } else {
            variationId = await ProductService.ensureDefaultVariation(row.productId);
          }
        } catch (e) {
          console.error('Failed to get/create variation for', row.productId, e);
          continue;
        }

        // Adjust stock
        await ProductService.adjustVariationStock(
          row.productId,
          variationId,
          delta,
          uid || undefined,
          auth.currentUser?.displayName || auth.currentUser?.email || 'Unknown'
        );
      }

      toast({ title: 'Success', description: `${validRows.length} product(s) adjusted successfully` });
      
      // Reset rows
      setAdjustmentRows(prev => prev.map(row => ({
        ...row,
        reason: '' as const,
        notes: '',
        expectedStock: items.find(i => i.id === row.productId)?.inStock || 0,
        countedStock: items.find(i => i.id === row.productId)?.inStock || 0,
        removeStock: 0,
      })));
    } catch (error) {
      console.error('Failed to submit adjustments:', error);
      toast({ title: 'Error', description: 'Failed to save adjustments. Please try again.', variant: 'destructive' });
    } finally {
      setSubmitting(false);
    }
  };

  // Open adjustment modal for a product or variation
  const handleOpenAdjustmentModal = (product: any, variation?: any) => {
    setAdjustingProduct(product.id);
    setAdjustingVariation(variation || null);
    
    const currentStock = variation ? (variation.stock || 0) : product.inStock;
    
    setAdjustmentForm({
      reason: '',
      notes: '',
      expectedStock: currentStock,
      countedStock: currentStock,
      removeStock: 0,
    });
    setShowAdjustmentModal(true);
  };

  // Save adjustment from modal
  const handleSaveAdjustment = async () => {
    if (!adjustingProduct || !adjustmentForm.reason || !adjustmentForm.notes.trim()) {
      toast({ title: 'Validation Error', description: 'Please fill in all required fields', variant: 'destructive' });
      return;
    }

    const product = items.find(i => i.id === adjustingProduct);
    if (!product) return;

    try {
      setSubmitting(true);

      // Get current stock from variation or product
      const currentStock = adjustingVariation ? (adjustingVariation.stock || 0) : product.inStock;

      // Calculate delta
      let delta: number;
      if (adjustmentForm.reason === 'Inventory Count') {
        delta = (adjustmentForm.countedStock || 0) - currentStock;
      } else {
        delta = -(adjustmentForm.removeStock || 0);
      }

      if (delta === 0) {
        toast({ title: 'No Change', description: 'No stock adjustment needed', variant: 'destructive' });
        return;
      }

      // Get variation ID
      let variationId: string;
      if (adjustingVariation) {
        // Use the specific variation being adjusted
        variationId = adjustingVariation.id;
      } else {
        // Get or create default variation for main product
        try {
          const vars = await ProductService.getVariations(adjustingProduct);
          if (vars && vars.length > 0) {
            variationId = vars[0].id;
          } else {
            variationId = await ProductService.ensureDefaultVariation(adjustingProduct);
          }
        } catch (e) {
          console.error('Failed to get/create variation for', adjustingProduct, e);
          toast({ title: 'Error', description: 'Failed to process stock adjustment', variant: 'destructive' });
          return;
        }
      }

      // Adjust stock
      await ProductService.adjustVariationStock(
        adjustingProduct,
        variationId,
        delta,
        uid || undefined,
        auth.currentUser?.displayName || auth.currentUser?.email || 'Unknown'
      );

      toast({ title: 'Success', description: 'Stock adjusted successfully' });
      setShowAdjustmentModal(false);
      setAdjustingProduct(null);
      setAdjustingVariation(null);
      setAdjustmentForm({
        reason: '',
        notes: '',
        expectedStock: 0,
        countedStock: 0,
        removeStock: 0,
      });
    } catch (error) {
      console.error('Failed to adjust stock:', error);
      toast({ title: 'Error', description: 'Failed to adjust stock. Please try again.', variant: 'destructive' });
    } finally {
      setSubmitting(false);
    }
  };

  // Open price modal for a product or variation
  const handleOpenPriceModal = (product: any, variation?: any) => {
    setPricingProduct(product.id);
    setPricingVariation(variation || null);
    
    const currentPrice = variation ? (variation.price || 0) : (product.price || 0);
    
    setPriceForm({
      currentPrice: currentPrice,
      newPrice: currentPrice,
      specialPrice: variation ? '' : (product.specialPrice || ''),
    });
    setShowPriceModal(true);
  };

  // Save price from modal
  const handleSavePrice = async () => {
    if (!pricingProduct) return;

    const product = items.find(i => i.id === pricingProduct);
    if (!product) return;

    const currentPrice = pricingVariation ? (pricingVariation.price || 0) : (product.price || 0);

    // Check if there are changes
    const priceChanged = priceForm.newPrice !== '' && Number(priceForm.newPrice) !== currentPrice;
    const specialPriceChanged = !pricingVariation && (
      (priceForm.specialPrice === '' && product.specialPrice) || 
      (priceForm.specialPrice !== '' && Number(priceForm.specialPrice) !== (product.specialPrice || 0))
    );

    if (!priceChanged && !specialPriceChanged) {
      toast({ title: 'No Changes', description: 'No price changes detected', variant: 'destructive' });
      return;
    }

    try {
      setSubmitting(true);

      if (pricingVariation) {
        // Update variation price
        await ProductService.updateVariation(pricingProduct, pricingVariation.id, {
          price: priceForm.newPrice !== '' ? Number(priceForm.newPrice) : 0,
        });
      } else {
        // Update product price and special price
        const priceValue = priceForm.newPrice !== '' ? Number(priceForm.newPrice) : (product.price || null);
        const specialPriceValue = priceForm.specialPrice !== '' ? Number(priceForm.specialPrice) : null;

        await ProductService.updatePriceAndPromo(
          pricingProduct,
          {
            price: priceValue,
            specialPrice: specialPriceValue,
            promoStart: null,
            promoEnd: null,
          },
          uid,
          undefined
        );
      }

      toast({ title: 'Success', description: 'Price updated successfully' });
      setShowPriceModal(false);
      setPricingProduct(null);
      setPricingVariation(null);
      setPriceForm({
        currentPrice: 0,
        newPrice: '',
        specialPrice: '',
      });
    } catch (error) {
      console.error('Failed to update price:', error);
      toast({ title: 'Error', description: 'Failed to update price. Please try again.', variant: 'destructive' });
    } finally {
      setSubmitting(false);
    }
  };

  const handleBulkPriceUpdate = async () => {
    const updatedRows = priceRows.filter(row => {
      const product = items.find(p => p.id === row.productId);
      if (!product) return false;
      // Check if price or specialPrice has changed
      const priceChanged = row.price !== '' && Number(row.price) !== (product.price || 0);
      const specialPriceChanged = (row.specialPrice === '' && product.specialPrice) || 
                                   (row.specialPrice !== '' && Number(row.specialPrice) !== (product.specialPrice || 0));
      return priceChanged || specialPriceChanged;
    });

    if (updatedRows.length === 0) {
      toast({ title: 'No Changes', description: 'No price changes detected', variant: 'destructive' });
      return;
    }

    setSubmitting(true);
    try {
      for (const row of updatedRows) {
        const product = items.find(p => p.id === row.productId);
        const priceValue = row.price !== '' ? Number(row.price) : (product?.price || null);
        const specialPriceValue = row.specialPrice !== '' ? Number(row.specialPrice) : null;

        await ProductService.updatePriceAndPromo(
          row.productId, 
          {
            price: priceValue,
            specialPrice: specialPriceValue,
            promoStart: null,
            promoEnd: null,
          },
          uid,
          undefined
        );
      }

      toast({ title: 'Success', description: `Updated prices for ${updatedRows.length} product(s)` });
      
      // Reset rows to current values after save
      const updatedIds = new Set(updatedRows.map(r => r.productId));
      setPriceRows(prev => prev.map(row => {
        if (!updatedIds.has(row.productId)) return row;
        const product = items.find(p => p.id === row.productId);
        return {
          productId: row.productId,
          price: product?.price || 0,
          specialPrice: product?.specialPrice || '',
        };
      }));
    } catch (error) {
      console.error('Failed to update prices:', error);
      toast({ title: 'Error', description: 'Failed to update prices. Please try again.', variant: 'destructive' });
    } finally {
      setSubmitting(false);
    }
  };

  const handleToggleActive = async (productId: string, nextActive: boolean) => {
    try {
      // Optimistically update UI for snappy toggle feedback
      setItems(prev => prev.map(i => i.id === productId ? ({
        ...i,
        isActive: nextActive,
        status: nextActive ? 'active' : (i.status === 'deleted' ? 'deleted' : 'inactive'),
      }) : i));

      await ProductService.toggleActive(productId, nextActive);
      toast({ 
        title: 'Success', 
        description: `Product ${nextActive ? 'activated' : 'deactivated'} successfully` 
      });
    } catch (error) {
      console.error('Failed to toggle active status:', error);
      // Revert optimistic update on failure
      setItems(prev => prev.map(i => i.id === productId ? ({
        ...i,
        isActive: !nextActive,
        status: !nextActive ? 'active' : (i.status === 'deleted' ? 'deleted' : 'inactive'),
      }) : i));
      toast({ 
        title: 'Error', 
        description: 'Failed to update product status', 
        variant: 'destructive' 
      });
    }
  };

  const handleItemEdit = async (product: any) => {
    setEditingItem(product.id);
    
    // Fetch variations for this product
    let variations: any[] = [];
    try {
      const unsub = ProductService.listenVariations(product.id, (vars) => {
        variations = vars.map((v: any) => ({
          id: v.id,
          name: v.name || '',
          SKU: v.SKU || v.sku || '',
          price: v.price || 0,
          stock: v.stock || 0,
          imageURL: v.imageURL || '',
          weight: v.weight || '',
          weightUnit: v.weightUnit || 'kg',
          dimensions: {
            length: v.dimensions?.length || '',
            width: v.dimensions?.width || '',
            height: v.dimensions?.height || ''
          },
          dimensionsUnit: v.dimensionsUnit || 'cm',
          isFragile: v.isFragile ?? false,
          isNew: false,
          isDeleted: false,
          imageFile: null,
          imagePreview: null
        }));
        
        setEditForm(prev => prev ? { ...prev, variations } : null);
      });
      // Clean up listener after getting initial data
      setTimeout(() => unsub(), 1000);
    } catch (error) {
      console.error('Failed to load variations:', error);
    }
    
    setEditForm({
      name: product.name || '',
      description: product.description || '',
      categoryID: product.category || '',
      subCategoryID: product.subcategory || '',
      price: product.price || 0,
      specialPrice: product.specialPrice || '',
      inStock: product.inStock || 0,
      suggestedThreshold: product.suggestedThreshold || 5,
      lowestPrice: product.lowestPrice || '',
      imageURL: product.imageUrl || '',
      imageFile: null,
      imagePreview: null,
      status: product.status || 'active',
      dangerousGoods: product.dangerousGoods || 'none',
      warrantyType: product.warrantyType || '',
      warrantyDuration: product.warrantyDuration || '',
      promoStart: product.promoStart || null,
      promoEnd: product.promoEnd || null,
      variations: variations,
    });

    // Load subcategories for the selected category
    if (product.category) {
      try {
        const unsub = CategoryService.listenSubcategories(product.category, (subs) => {
          setSubcategoryOptions(subs);
        });
        // Clean up after a brief moment since we just need initial data
        setTimeout(() => unsub(), 1000);
      } catch (error) {
        console.error('Failed to load subcategories:', error);
      }
    }

    setShowEditModal(true);
  };

  const handleItemSave = async () => {
    if (!editForm || !editingItem) return;

    setSubmitting(true);
    try {
      let imageUrl = editForm.imageURL;

      // Upload new image if selected
      if (editForm.imageFile) {
        const timestamp = Date.now();
        const path = `ProductImages/${timestamp}/${editForm.imageFile.name}`;
        const sRef = storageRef(storage, path);
        await uploadBytes(sRef, editForm.imageFile);
        imageUrl = await getDownloadURL(sRef);
      }

      // Update product details
      await ProductService.updateProduct(editingItem, {
        name: editForm.name,
        description: editForm.description,
        imageURL: imageUrl,
        categoryID: editForm.categoryID || null,
        subCategoryID: editForm.subCategoryID || null,
        suggestedThreshold: editForm.suggestedThreshold,
        lowestPrice: editForm.lowestPrice !== '' ? Number(editForm.lowestPrice) : null,
        status: editForm.status,
        dangerousGoods: editForm.dangerousGoods,
        warrantyType: editForm.warrantyType || null,
        warrantyDuration: editForm.warrantyDuration || null,
      } as any);

      // Update pricing
      await ProductService.updatePriceAndPromo(
        editingItem,
        {
          price: editForm.price,
          specialPrice: editForm.specialPrice !== '' ? Number(editForm.specialPrice) : null,
          promoStart: editForm.promoStart,
          promoEnd: editForm.promoEnd,
        },
        uid,
        undefined
      );

      // Handle variations
      for (const variation of editForm.variations) {
        let variationImageUrl = variation.imageURL;
        
        // Upload variation image if new file selected
        if (variation.imageFile) {
          const timestamp = Date.now();
          const path = `ProductImages/variations/${timestamp}/${variation.imageFile.name}`;
          const sRef = storageRef(storage, path);
          await uploadBytes(sRef, variation.imageFile);
          variationImageUrl = await getDownloadURL(sRef);
        }
        
        if (variation.isDeleted && variation.id) {
          // Delete existing variation
          await ProductService.deleteVariation(editingItem, variation.id);
        } else if (variation.isNew) {
          // Add new variation
          await ProductService.addVariations(editingItem, [{
            name: variation.name,
            sku: variation.SKU,
            price: variation.price,
            stock: variation.stock,
            weight: variation.weight !== '' ? Number(variation.weight) : undefined,
            weightUnit: variation.weightUnit,
            dimensions: {
              length: variation.dimensions.length !== '' ? Number(variation.dimensions.length) : undefined,
              width: variation.dimensions.width !== '' ? Number(variation.dimensions.width) : undefined,
              height: variation.dimensions.height !== '' ? Number(variation.dimensions.height) : undefined,
            },
            dimensionsUnit: variation.dimensionsUnit,
            imageURL: variationImageUrl || null,
            isFragile: variation.isFragile ?? false,
          }]);
        } else if (variation.id) {
          // Update existing variation
          await ProductService.updateVariation(editingItem, variation.id, {
            name: variation.name,
            SKU: variation.SKU,
            price: variation.price,
            stock: variation.stock,
            weight: variation.weight !== '' ? Number(variation.weight) : undefined,
            weightUnit: variation.weightUnit,
            dimensions: {
              length: variation.dimensions.length !== '' ? Number(variation.dimensions.length) : undefined,
              width: variation.dimensions.width !== '' ? Number(variation.dimensions.width) : undefined,
              height: variation.dimensions.height !== '' ? Number(variation.dimensions.height) : undefined,
            },
            dimensionsUnit: variation.dimensionsUnit,
            imageURL: variationImageUrl,
            isFragile: variation.isFragile ?? false,
          });
        }
      }

      toast({ title: 'Success', description: 'Product updated successfully' });
      setShowEditModal(false);
      setEditingItem(null);
      setEditForm(null);
    } catch (error) {
      console.error('Failed to update product:', error);
      toast({ title: 'Error', description: 'Failed to update product. Please try again.', variant: 'destructive' });
    } finally {
      setSubmitting(false);
    }
  };

  // Toggle product expansion and fetch variations
  const toggleProductExpansion = (productId: string) => {
    const newExpanded = new Set(expandedProducts);
    if (newExpanded.has(productId)) {
      newExpanded.delete(productId);
      setExpandedProducts(newExpanded);
    } else {
      newExpanded.add(productId);
      setExpandedProducts(newExpanded);
      
      // Fetch variations if not already loaded
      if (!productVariations[productId]) {
        const newLoading = new Set(loadingVariations);
        newLoading.add(productId);
        setLoadingVariations(newLoading);
        
        const unsub = ProductService.listenVariations(productId, (variations) => {
          setProductVariations(prev => ({ ...prev, [productId]: variations }));
          const updatedLoading = new Set(loadingVariations);
          updatedLoading.delete(productId);
          setLoadingVariations(updatedLoading);
        });
        
        // Store unsub function if needed for cleanup
        // For now, variations will be fetched once and cached
      }
    }
  };

  // Stock Adjustment View Component
  const renderStockAdjustmentView = () => {
    const currentProduct = adjustingProduct ? items.find(i => i.id === adjustingProduct) : null;
    
    return (
      <div className="space-y-6">
        {/* Filters */}
        <div className="bg-white rounded-lg border border-gray-200 p-4">
          <h2 className="text-xl font-semibold text-gray-900 mb-4">Stock Adjustment</h2>
          
          <div className="flex flex-wrap gap-3 items-center">
            <input
              value={adjustmentFilterName}
              onChange={(e) => setAdjustmentFilterName(e.target.value)}
              placeholder="Filter by product name"
              className="w-64 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
            />
            <select
              value={adjustmentFilterCategory}
              onChange={(e) => setAdjustmentFilterCategory(e.target.value)}
              className="w-48 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
            >
              <option value="">All categories</option>
              {categoriesList.map((cat) => (
                <option key={cat.id} value={cat.id}>{cat.name}</option>
              ))}
            </select>
            <select
              value={adjustmentSortBy}
              onChange={(e) => setAdjustmentSortBy(e.target.value as any)}
              className="w-52 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
            >
              <option value="name">Sort by: Name</option>
              <option value="stock">Sort by: Stock (High-Low)</option>
              <option value="stockAsc">Sort by: Stock (Low-High)</option>
              <option value="updatedAt">Sort by: Recently Updated</option>
            </select>
            <label className="inline-flex items-center gap-2 text-sm text-gray-700">
              <input 
                type="checkbox" 
                className="accent-teal-600" 
                checked={adjustmentLowOnly} 
                onChange={(e) => setAdjustmentLowOnly(e.target.checked)} 
              />
              Low stock only
            </label>
          </div>
        </div>

        {/* Products Table */}
        <div className="bg-white rounded-lg border border-gray-200">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider w-8"></th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Product</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">Current Stock</th>
                  <th className="px-6 py-4 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">Action</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {filteredAdjustmentProducts.map((product) => {
                  const variations = productVariations[product.id] || [];
                  const hasVariations = (product.variationCount || 0) > 0;
                  const isExpanded = expandedProducts.has(product.id);
                  const isLoadingVariations = loadingVariations.has(product.id);

                  return (
                    <React.Fragment key={product.id}>
                      {/* Main Product Row */}
                      <tr className="hover:bg-gray-50 transition">
                        <td className="px-6 py-4">
                          {hasVariations && (
                            <button
                              onClick={() => toggleProductExpansion(product.id)}
                              className="p-1 hover:bg-gray-200 rounded transition"
                            >
                              {isExpanded ? (
                                <ChevronDown className="w-4 h-4 text-gray-600" />
                              ) : (
                                <ChevronRight className="w-4 h-4 text-gray-600" />
                              )}
                            </button>
                          )}
                        </td>
                        <td className="px-6 py-4">
                          <div className="flex items-center gap-3">
                            {product.imageUrl ? (
                              <img src={product.imageUrl} alt={product.name} className="w-12 h-12 rounded-lg object-cover border border-gray-200" />
                            ) : (
                              <div className="w-12 h-12 rounded-lg bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center">
                                <Package className="w-6 h-6 text-gray-400" />
                              </div>
                            )}
                            <div>
                              <div className="flex items-center gap-2">
                                <span className="font-medium text-gray-900">{product.name}</span>
                                {/* Removed V badge for variations in Stock Adjustment */}
                              </div>
                              <div className="text-xs text-gray-500">{product.categoryName || 'Uncategorized'}</div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4">
                          <div className="flex items-center gap-2">
                            <span className={`text-lg font-semibold ${
                              product.inStock <= (product.suggestedThreshold || 5) 
                                ? 'text-red-600' 
                                : product.inStock <= (product.suggestedThreshold || 5) * 2 
                                ? 'text-yellow-600' 
                                : 'text-green-600'
                            }`}>
                              {product.inStock}
                            </span>
                            {product.inStock <= (product.suggestedThreshold || 5) && (
                              <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                Low Stock
                              </span>
                            )}
                          </div>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <button
                            onClick={() => handleOpenAdjustmentModal(product)}
                            className="inline-flex items-center gap-2 px-4 py-2 bg-teal-600 text-white font-medium rounded-lg hover:bg-teal-700 transition shadow-sm hover:shadow-md"
                          >
                            <Edit className="w-4 h-4" />
                            Adjust Stock
                          </button>
                        </td>
                      </tr>

                      {/* Variations Rows */}
                      {isExpanded && (
                        <>
                          {isLoadingVariations ? (
                            <tr>
                              <td colSpan={4} className="px-6 py-4 bg-gray-50/50">
                                <div className="flex items-center justify-center gap-2 text-sm text-gray-500">
                                  <div className="animate-spin rounded-full h-4 w-4 border-2 border-teal-600 border-t-transparent"></div>
                                  Loading variations...
                                </div>
                              </td>
                            </tr>
                          ) : variations.length > 0 ? (
                            variations.map((variation) => (
                              <tr key={variation.id} className="bg-gray-50/50 hover:bg-gray-100/50 transition">
                                <td className="px-6 py-3"></td>
                                <td className="px-6 py-3">
                                  <div className="flex items-center gap-3 pl-8">
                                    {variation.imageURL ? (
                                      <img 
                                        src={variation.imageURL} 
                                        alt={variation.name || 'Variation'} 
                                        className="w-10 h-10 rounded-lg object-cover border border-gray-200" 
                                      />
                                    ) : (
                                      <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                                        <Package className="w-5 h-5 text-gray-400" />
                                      </div>
                                    )}
                                    <div>
                                      <div className="text-sm font-medium text-gray-800">
                                        {variation.name || 'Unnamed Variation'}
                                      </div>
                                      {variation.SKU && (
                                        <div className="text-xs text-gray-500">SKU: {variation.SKU}</div>
                                      )}
                                    </div>
                                  </div>
                                </td>
                                <td className="px-6 py-3">
                                  <div className="flex items-center gap-2">
                                    <span className={`text-base font-semibold ${
                                      (variation.stock || 0) <= 5
                                        ? 'text-red-600' 
                                        : (variation.stock || 0) <= 10
                                        ? 'text-yellow-600' 
                                        : 'text-green-600'
                                    }`}>
                                      {variation.stock || 0}
                                    </span>
                                    {(variation.stock || 0) <= 5 && (
                                      <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                        Low Stock
                                      </span>
                                    )}
                                  </div>
                                </td>
                                <td className="px-6 py-3 text-center">
                                  <button
                                    onClick={() => handleOpenAdjustmentModal(product, variation)}
                                    className="inline-flex items-center gap-2 px-3 py-1.5 bg-teal-600 text-white text-sm font-medium rounded-lg hover:bg-teal-700 transition shadow-sm"
                                  >
                                    <Edit className="w-3.5 h-3.5" />
                                    Adjust
                                  </button>
                                </td>
                              </tr>
                            ))
                          ) : (
                            <tr>
                              <td colSpan={4} className="px-6 py-4 bg-gray-50/50 text-center text-sm text-gray-500">
                                No variations found
                              </td>
                            </tr>
                          )}
                        </>
                      )}
                    </React.Fragment>
                  );
                })}
                {filteredAdjustmentProducts.length === 0 && (
                  <tr>
                    <td colSpan={4} className="px-6 py-12 text-center">
                      <Package className="mx-auto h-12 w-12 text-gray-400 mb-3" />
                      <p className="text-gray-500">No products found. Adjust your filters.</p>
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* Adjustment Modal */}
        {showAdjustmentModal && currentProduct && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
            <div className="relative bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
              {/* Modal Header */}
              <div className="sticky top-0 bg-gradient-to-r from-teal-600 to-teal-700 px-6 py-5 rounded-t-2xl">
                <div className="flex items-center justify-between">
                  <div>
                    <h2 className="text-xl font-bold text-white">Adjust Stock</h2>
                    <p className="text-teal-100 text-sm mt-1">Update inventory for this product</p>
                  </div>
                  <button
                    onClick={() => !submitting && setShowAdjustmentModal(false)}
                    className="text-white/80 hover:text-white hover:bg-white/10 p-2 rounded-lg transition"
                  >
                    <X className="w-6 h-6" />
                  </button>
                </div>
              </div>

              {/* Modal Body */}
              <div className="p-6 space-y-6">
                {/* Product Info Card */}
                <div className="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-5 border border-gray-200">
                  <div className="flex items-center gap-4">
                    {adjustingVariation ? (
                      // Show variation image if adjusting a variation
                      adjustingVariation.imageURL ? (
                        <img src={adjustingVariation.imageURL} alt={adjustingVariation.name || 'Variation'} className="w-20 h-20 rounded-lg object-cover border-2 border-white shadow-md" />
                      ) : (
                        <div className="w-20 h-20 rounded-lg bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center shadow-md">
                          <Package className="w-10 h-10 text-gray-400" />
                        </div>
                      )
                    ) : (
                      // Show product image if adjusting main product
                      currentProduct.imageUrl ? (
                        <img src={currentProduct.imageUrl} alt={currentProduct.name} className="w-20 h-20 rounded-lg object-cover border-2 border-white shadow-md" />
                      ) : (
                        <div className="w-20 h-20 rounded-lg bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center shadow-md">
                          <Package className="w-10 h-10 text-gray-400" />
                        </div>
                      )
                    )}
                    <div className="flex-1">
                      <h3 className="text-lg font-semibold text-gray-900">{currentProduct.name}</h3>
                      {adjustingVariation && (
                        <div className="flex items-center gap-2 mt-1">
                          <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 border border-purple-200">
                            Variation
                          </span>
                          <span className="text-sm font-medium text-gray-700">{adjustingVariation.name || 'Unnamed'}</span>
                        </div>
                      )}
                      {adjustingVariation?.SKU && (
                        <p className="text-xs text-gray-500 mt-0.5">SKU: {adjustingVariation.SKU}</p>
                      )}
                      <p className="text-sm text-gray-600 mt-1">{categoryMap[currentProduct.category as string] || currentProduct.category || 'Uncategorized'}</p>
                      <div className="mt-2 inline-flex items-center gap-2 px-3 py-1 bg-white rounded-lg border border-gray-300">
                        <span className="text-xs font-medium text-gray-600">Current Stock:</span>
                        <span className="text-lg font-bold text-teal-600">
                          {adjustingVariation ? (adjustingVariation.stock || 0) : currentProduct.inStock}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Reason Selection */}
                <div>
                  <label className="block text-sm font-semibold text-gray-800 mb-2">
                    Adjustment Reason <span className="text-red-500">*</span>
                  </label>
                  <select
                    value={adjustmentForm.reason}
                    onChange={(e) => {
                      const newReason = e.target.value as any;
                      setAdjustmentForm({
                        ...adjustmentForm,
                        reason: newReason,
                        expectedStock: currentProduct.inStock,
                        countedStock: currentProduct.inStock,
                        removeStock: 0,
                      });
                    }}
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition text-gray-900 font-medium"
                  >
                    <option value="">Select a reason...</option>
                    <option value="Inventory Count"> Inventory Count</option>
                    <option value="Loss"> Loss</option>
                    <option value="Damaged"> Damaged</option>
                  </select>
                </div>

                {/* Adjustment Details */}
                {adjustmentForm.reason && (
                  <div className="bg-blue-50 rounded-xl p-5 border-2 border-blue-200">
                    <h4 className="text-sm font-semibold text-blue-900 mb-4 flex items-center gap-2">
                      <AlertTriangle className="w-4 h-4" />
                      Stock Adjustment Details
                    </h4>
                    {adjustmentForm.reason === 'Inventory Count' ? (
                      <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-2">Expected Stock</label>
                            <input
                              type="number"
                              value={adjustmentForm.expectedStock || 0}
                              readOnly
                              className="w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-600 font-semibold"
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-2">Counted Stock</label>
                            <input
                              type="number"
                              value={adjustmentForm.countedStock || 0}
                              onChange={(e) => setAdjustmentForm({ ...adjustmentForm, countedStock: parseInt(e.target.value) || 0 })}
                              min="0"
                              className="w-full px-4 py-3 border-2 border-teal-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 font-semibold text-gray-900"
                            />
                          </div>
                        </div>
                        <div className="bg-white rounded-lg p-4 border border-blue-300">
                          <div className="flex items-center justify-between">
                            <span className="text-sm font-medium text-gray-700">Adjustment:</span>
                            <span className={`text-xl font-bold ${
                              ((adjustmentForm.countedStock || 0) - (adjustmentForm.expectedStock || 0)) > 0 
                                ? 'text-green-600' 
                                : ((adjustmentForm.countedStock || 0) - (adjustmentForm.expectedStock || 0)) < 0 
                                ? 'text-red-600' 
                                : 'text-gray-600'
                            }`}>
                              {((adjustmentForm.countedStock || 0) - (adjustmentForm.expectedStock || 0)) > 0 ? '+' : ''}
                              {(adjustmentForm.countedStock || 0) - (adjustmentForm.expectedStock || 0)}
                            </span>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-2">Current Stock</label>
                            <input
                              type="number"
                              value={adjustingVariation ? (adjustingVariation.stock || 0) : currentProduct.inStock}
                              readOnly
                              className="w-full px-4 py-3 bg-gray-100 border border-gray-300 rounded-lg text-gray-600 font-semibold"
                            />
                          </div>
                          <div>
                            <label className="block text-xs font-medium text-gray-700 mb-2">Remove Quantity</label>
                            <input
                              type="number"
                              value={adjustmentForm.removeStock || 0}
                              onChange={(e) => {
                                const maxStock = adjustingVariation ? (adjustingVariation.stock || 0) : currentProduct.inStock;
                                const value = Math.min(parseInt(e.target.value) || 0, maxStock);
                                setAdjustmentForm({ ...adjustmentForm, removeStock: value });
                              }}
                              min="0"
                              max={adjustingVariation ? (adjustingVariation.stock || 0) : currentProduct.inStock}
                              className="w-full px-4 py-3 border-2 border-red-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 font-semibold text-gray-900"
                            />
                          </div>
                        </div>
                        <div className="bg-white rounded-lg p-4 border border-blue-300">
                          <div className="flex items-center justify-between">
                            <span className="text-sm font-medium text-gray-700">After Adjustment:</span>
                            <span className="text-xl font-bold text-gray-900">
                              {Math.max(0, (adjustingVariation ? (adjustingVariation.stock || 0) : currentProduct.inStock) - (adjustmentForm.removeStock || 0))}
                            </span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Notes */}
                <div>
                  <label className="block text-sm font-semibold text-gray-800 mb-2">
                    Notes <span className="text-red-500">*</span>
                  </label>
                  <textarea
                    value={adjustmentForm.notes}
                    onChange={(e) => setAdjustmentForm({ ...adjustmentForm, notes: e.target.value })}
                    rows={4}
                    placeholder="Enter detailed notes about this adjustment..."
                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition resize-none"
                  />
                  <p className="mt-2 text-xs text-gray-500">Provide context for this stock adjustment for audit purposes</p>
                </div>
              </div>

              {/* Modal Footer */}
              <div className="sticky bottom-0 bg-gray-50 px-6 py-4 rounded-b-2xl border-t border-gray-200 flex items-center justify-end gap-3">
                <button
                  onClick={() => !submitting && setShowAdjustmentModal(false)}
                  disabled={submitting}
                  className="px-5 py-2.5 border-2 border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition disabled:opacity-50"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSaveAdjustment}
                  disabled={submitting || !adjustmentForm.reason || !adjustmentForm.notes.trim()}
                  className="px-6 py-2.5 bg-teal-600 text-white font-medium rounded-lg hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-sm hover:shadow-md flex items-center gap-2"
                >
                  {submitting ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                      Saving...
                    </>
                  ) : (
                    <>
                      <CheckCircle2 className="w-4 h-4" />
                      Save Adjustment
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Price Management View Component
  const renderPriceManagementView = () => {
    return (
      <div className="space-y-6">
        {/* Filters */}
        <div className="bg-white rounded-lg border border-gray-200 p-4">
          <h2 className="text-xl font-semibold text-gray-900 mb-4">Price Management</h2>
          
          <div className="flex flex-wrap gap-3 items-center">
            <input
              value={priceFilterName}
              onChange={(e) => setPriceFilterName(e.target.value)}
              placeholder="Filter by product name"
              className="w-64 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
            <select
              value={priceFilterCategory}
              onChange={(e) => setPriceFilterCategory(e.target.value)}
              className="w-48 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="">All categories</option>
              {categoriesList.map((cat) => (
                <option key={cat.id} value={cat.id}>{cat.name}</option>
              ))}
            </select>
            <select
              value={priceSortBy}
              onChange={(e) => setPriceSortBy(e.target.value as any)}
              className="w-48 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="name">Sort by Name (A-Z)</option>
              <option value="price">Sort by Price (High-Low)</option>
              <option value="priceAsc">Sort by Price (Low-High)</option>
              <option value="updatedAt">Sort by Recently Updated</option>
            </select>
          </div>
        </div>

        {/* Products Table */}
        <div className="bg-white rounded-lg border border-gray-200 shadow-sm">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gradient-to-r from-blue-50 to-indigo-50 border-b border-gray-200">
                <tr>
                  <th className="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider w-8"></th>
                  <th className="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Product</th>
                  <th className="px-6 py-4 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Current Price</th>
                  <th className="px-6 py-4 text-center text-xs font-bold text-gray-700 uppercase tracking-wider">Action</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {filteredPriceProducts.map((product) => {
                  const variations = productVariations[product.id] || [];
                  const hasVariations = (product.variationCount || 0) > 0;
                  const isExpanded = expandedProducts.has(product.id);
                  const isLoadingVariations = loadingVariations.has(product.id);

                  return (
                    <React.Fragment key={product.id}>
                      {/* Main Product Row */}
                      <tr className="hover:bg-blue-50/30 transition">
                        <td className="px-6 py-4">
                          {hasVariations && (
                            <button
                              onClick={() => toggleProductExpansion(product.id)}
                              className="p-1 hover:bg-gray-200 rounded transition"
                            >
                              {isExpanded ? (
                                <ChevronDown className="w-4 h-4 text-gray-600" />
                              ) : (
                                <ChevronRight className="w-4 h-4 text-gray-600" />
                              )}
                            </button>
                          )}
                        </td>
                        <td className="px-6 py-4">
                          <div className="flex items-center gap-4">
                            {product.imageUrl && (
                              <img 
                                src={product.imageUrl} 
                                alt={product.name} 
                                className="w-12 h-12 rounded-lg object-cover border border-gray-200 shadow-sm" 
                              />
                            )}
                            <div>
                              <div className="flex items-center gap-2">
                                <span className="text-sm font-semibold text-gray-900">{product.name}</span>
                                {/* Removed V badge for variations in Price Management */}
                              </div>
                              <div className="text-xs text-gray-500">{product.categoryName || 'Uncategorized'}</div>
                            </div>
                          </div>
                        </td>
                        <td className="px-6 py-4">
                          <div className="flex items-center gap-2">
                            <span className="text-lg font-bold text-gray-900">{(product.price || 0).toFixed(2)}</span>
                            {product.specialPrice && (
                              <span className="px-2 py-1 text-xs font-semibold bg-gradient-to-r from-orange-100 to-red-100 text-red-700 rounded-full border border-red-200">
                                Promo: {product.specialPrice.toFixed(2)}
                              </span>
                            )}
                          </div>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <button
                            onClick={() => handleOpenPriceModal(product)}
                            className="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-sm font-medium rounded-lg hover:from-blue-700 hover:to-indigo-700 transition shadow-sm hover:shadow-md"
                          >
                            <CreditCard className="w-4 h-4" />
                            Update Price
                          </button>
                        </td>
                      </tr>

                      {/* Variations Rows */}
                      {isExpanded && (
                        <>
                          {isLoadingVariations ? (
                            <tr>
                              <td colSpan={4} className="px-6 py-4 bg-blue-50/20">
                                <div className="flex items-center justify-center gap-2 text-sm text-gray-500">
                                  <div className="animate-spin rounded-full h-4 w-4 border-2 border-blue-600 border-t-transparent"></div>
                                  Loading variations...
                                </div>
                              </td>
                            </tr>
                          ) : variations.length > 0 ? (
                            variations.map((variation) => (
                              <tr key={variation.id} className="bg-blue-50/20 hover:bg-blue-50/40 transition">
                                <td className="px-6 py-3"></td>
                                <td className="px-6 py-3">
                                  <div className="flex items-center gap-3 pl-8">
                                    {variation.imageURL ? (
                                      <img 
                                        src={variation.imageURL} 
                                        alt={variation.name || 'Variation'} 
                                        className="w-10 h-10 rounded-lg object-cover border border-gray-200" 
                                      />
                                    ) : (
                                      <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center">
                                        <Package className="w-5 h-5 text-gray-400" />
                                      </div>
                                    )}
                                    <div>
                                      <div className="text-sm font-medium text-gray-800">
                                        {variation.name || 'Unnamed Variation'}
                                      </div>
                                      {variation.SKU && (
                                        <div className="text-xs text-gray-500">SKU: {variation.SKU}</div>
                                      )}
                                    </div>
                                  </div>
                                </td>
                                <td className="px-6 py-3">
                                  <div className="flex items-center gap-2">
                                    <span className="text-base font-bold text-gray-900">{(variation.price || 0).toFixed(2)}</span>
                                  </div>
                                </td>
                                <td className="px-6 py-3 text-center">
                                  <button
                                    onClick={() => handleOpenPriceModal(product, variation)}
                                    className="inline-flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white text-sm font-medium rounded-lg hover:from-blue-700 hover:to-indigo-700 transition shadow-sm"
                                  >
                                    <CreditCard className="w-3.5 h-3.5" />
                                    Update
                                  </button>
                                </td>
                              </tr>
                            ))
                          ) : (
                            <tr>
                              <td colSpan={4} className="px-6 py-4 bg-blue-50/20 text-center text-sm text-gray-500">
                                No variations found
                              </td>
                            </tr>
                          )}
                        </>
                      )}
                    </React.Fragment>
                  );
                })}
              </tbody>
            </table>
          </div>

          {filteredPriceProducts.length === 0 && (
            <div className="text-center py-16">
              <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 mb-4">
                <CreditCard className="w-8 h-8 text-blue-600" />
              </div>
              <p className="text-sm font-medium text-gray-700">No products found</p>
              <p className="text-xs text-gray-500 mt-1">Try adjusting your filters</p>
            </div>
          )}
        </div>

        {/* Price Management Modal */}
        {showPriceModal && pricingProduct && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
            <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col animate-in zoom-in-95 duration-200">
              {/* Modal Header */}
              <div className="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 px-6 py-5 flex items-center justify-between border-b border-blue-700/30">
                <div>
                  <h3 className="text-xl font-bold text-white flex items-center gap-2">
                    <CreditCard className="w-6 h-6" />
                    Update Product Price
                  </h3>
                  <p className="text-blue-100 text-sm mt-1">Manage pricing and promotional offers</p>
                </div>
                <button
                  onClick={() => !submitting && setShowPriceModal(false)}
                  disabled={submitting}
                  className="text-white/80 hover:text-white hover:bg-white/10 rounded-lg p-2 transition disabled:opacity-50"
                >
                  <X className="w-5 h-5" />
                </button>
              </div>

              {/* Modal Body */}
              <div className="flex-1 overflow-y-auto p-6 space-y-6">
                {(() => {
                  const currentProduct = filteredPriceProducts.find(p => p.id === pricingProduct);
                  if (!currentProduct) return null;

                  return (
                    <>
                      {/* Product Info Card */}
                      <div className="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 rounded-xl p-5 border-2 border-blue-200/50 shadow-sm">
                        <div className="flex items-center gap-4">
                          {pricingVariation ? (
                            // Show variation image if pricing a variation
                            pricingVariation.imageURL ? (
                              <img src={pricingVariation.imageURL} alt={pricingVariation.name || 'Variation'} className="w-20 h-20 rounded-xl object-cover border-2 border-white shadow-md" />
                            ) : (
                              <div className="w-20 h-20 rounded-xl bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center shadow-md">
                                <Package className="w-10 h-10 text-gray-400" />
                              </div>
                            )
                          ) : (
                            // Show product image if pricing main product
                            currentProduct.imageUrl ? (
                              <img src={currentProduct.imageUrl} alt={currentProduct.name} className="w-20 h-20 rounded-xl object-cover border-2 border-white shadow-md" />
                            ) : (
                              <div className="w-20 h-20 rounded-xl bg-gradient-to-br from-gray-200 to-gray-300 flex items-center justify-center shadow-md">
                                <Package className="w-10 h-10 text-gray-400" />
                              </div>
                            )
                          )}
                          <div className="flex-1">
                            <h4 className="text-lg font-bold text-gray-900">{currentProduct.name}</h4>
                            {pricingVariation && (
                              <div className="flex items-center gap-2 mt-1">
                                <span className="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-gradient-to-r from-purple-100 to-pink-100 text-purple-700 border border-purple-200">
                                  Variation
                                </span>
                                <span className="text-sm font-medium text-gray-700">{pricingVariation.name || 'Unnamed'}</span>
                              </div>
                            )}
                            {pricingVariation?.SKU && (
                              <p className="text-xs text-gray-500 mt-0.5">SKU: {pricingVariation.SKU}</p>
                            )}
                            <p className="text-sm text-gray-600 mt-1">{currentProduct.categoryName || 'Uncategorized'}</p>
                            <div className="flex items-center gap-2 mt-2">
                              <span className="px-3 py-1 bg-white/80 backdrop-blur-sm rounded-full text-xs font-bold text-blue-700 border border-blue-200 shadow-sm">
                                Current: {(pricingVariation ? (pricingVariation.price || 0) : (currentProduct.price || 0)).toFixed(2)}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Pricing Section */}
                      <div className="space-y-5">
                        {/* Current Price Display */}
                        <div className="bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl p-5 border border-gray-300">
                          <label className="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <span className="w-2 h-2 rounded-full bg-gray-500"></span>
                            Current Price
                          </label>
                          <div className="flex items-center gap-3">
                            <span className="text-3xl font-bold text-gray-900"></span>
                            <span className="text-4xl font-bold text-gray-900">{(priceForm.currentPrice || 0).toFixed(2)}</span>
                          </div>
                          <p className="mt-2 text-xs text-gray-600">This is the active selling price</p>
                        </div>

                        {/* New Price Input */}
                        <div className="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 border-2 border-blue-300">
                          <label className="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <span className="w-2 h-2 rounded-full bg-blue-600"></span>
                            New Price
                            <span className="text-red-500">*</span>
                          </label>
                          <div className="flex items-center gap-3 bg-white rounded-lg p-3 border-2 border-blue-400 shadow-sm">
                            <span className="text-2xl font-bold text-blue-600"></span>
                            <input
                              type="number"
                              value={priceForm.newPrice}
                              onChange={(e) => setPriceForm({ ...priceForm, newPrice: e.target.value === '' ? '' : Number(e.target.value) })}
                              min="0"
                              step="0.01"
                              placeholder="0.00"
                              className="flex-1 text-2xl font-bold text-gray-900 bg-transparent border-none outline-none placeholder:text-gray-300"
                            />
                          </div>
                          <p className="mt-2 text-xs text-gray-600">Enter the new regular price for this product</p>
                        </div>

                        {/* Special Price Input (Optional) - Only for main products, not variations */}
                        {!pricingVariation && (
                          <div className="bg-gradient-to-br from-orange-50 to-red-50 rounded-xl p-5 border-2 border-orange-300">
                            <label className="block text-sm font-bold text-gray-800 mb-3 flex items-center gap-2">
                              <span className="w-2 h-2 rounded-full bg-orange-500"></span>
                              Special/Promo Price
                              <span className="text-xs font-normal text-gray-500">(Optional)</span>
                            </label>
                            <div className="flex items-center gap-3 bg-white rounded-lg p-3 border-2 border-orange-400 shadow-sm">
                              <span className="text-2xl font-bold text-orange-600"></span>
                              <input
                                type="number"
                                value={priceForm.specialPrice}
                                onChange={(e) => setPriceForm({ ...priceForm, specialPrice: e.target.value === '' ? '' : Number(e.target.value) })}
                                min="0"
                                step="0.01"
                                placeholder="0.00"
                                className="flex-1 text-2xl font-bold text-gray-900 bg-transparent border-none outline-none placeholder:text-gray-300"
                              />
                            </div>
                            <p className="mt-2 text-xs text-gray-600">
                              Set a promotional price lower than the regular price. Leave empty to remove promo.
                            </p>
                            {priceForm.specialPrice && priceForm.newPrice && Number(priceForm.specialPrice) >= Number(priceForm.newPrice) && (
                              <div className="mt-3 flex items-start gap-2 bg-yellow-50 border border-yellow-300 rounded-lg p-3">
                                <AlertTriangle className="w-4 h-4 text-yellow-600 mt-0.5 flex-shrink-0" />
                                <p className="text-xs text-yellow-800">Special price should be lower than the regular price</p>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Price Comparison */}
                        {priceForm.newPrice && priceForm.currentPrice !== priceForm.newPrice && (
                          <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-5 border border-green-300">
                            <div className="flex items-center justify-between">
                              <span className="text-sm font-semibold text-gray-700">Price Change:</span>
                              <span className={`text-xl font-bold ${
                                Number(priceForm.newPrice) > priceForm.currentPrice 
                                  ? 'text-green-600' 
                                  : 'text-red-600'
                              }`}>
                                {Number(priceForm.newPrice) > priceForm.currentPrice ? '+' : ''}
                                {(Number(priceForm.newPrice) - priceForm.currentPrice).toFixed(2)}
                              </span>
                            </div>
                          </div>
                        )}
                      </div>
                    </>
                  );
                })()}
              </div>

              {/* Modal Footer */}
              <div className="sticky bottom-0 bg-gray-50 px-6 py-4 rounded-b-2xl border-t border-gray-200 flex items-center justify-end gap-3">
                <button
                  onClick={() => !submitting && setShowPriceModal(false)}
                  disabled={submitting}
                  className="px-5 py-2.5 border-2 border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-100 transition disabled:opacity-50"
                >
                  Cancel
                </button>
                <button
                  onClick={handleSavePrice}
                  disabled={submitting || !priceForm.newPrice || (priceForm.specialPrice && Number(priceForm.specialPrice) >= Number(priceForm.newPrice))}
                  className="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-medium rounded-lg hover:from-blue-700 hover:to-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-sm hover:shadow-md flex items-center gap-2"
                >
                  {submitting ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                      Saving...
                    </>
                  ) : (
                    <>
                      <CheckCircle2 className="w-4 h-4" />
                      Save Price
                    </>
                  )}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  };

  // Item Management View Component
  const renderItemManagementView = () => {
    return (
      <div className="space-y-6">
        {/* Filters */}
        <div className="bg-white rounded-lg border border-gray-200 p-4">
          <h2 className="text-xl font-semibold text-gray-900 mb-4">Item Management</h2>
          
          <div className="flex flex-wrap gap-3 items-center">
            <input
              value={itemMgmtFilterName}
              onChange={(e) => setItemMgmtFilterName(e.target.value)}
              placeholder="Filter by product name"
              className="w-64 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
            />
            <select
              value={itemMgmtFilterCategory}
              onChange={(e) => setItemMgmtFilterCategory(e.target.value)}
              className="w-48 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
            >
              <option value="">All categories</option>
              {categoriesList.map((cat) => (
                <option key={cat.id} value={cat.id}>{cat.name}</option>
              ))}
            </select>
            <select
              value={itemMgmtSortBy}
              onChange={(e) => setItemMgmtSortBy(e.target.value as any)}
              className="w-48 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
            >
              <option value="name">Sort by Name (A-Z)</option>
              <option value="price">Sort by Price (High-Low)</option>
              <option value="stock">Sort by Stock (High-Low)</option>
              <option value="updatedAt">Sort by Recently Updated</option>
            </select>
          </div>
        </div>

        {/* Products Table */}
        <div className="bg-white rounded-lg border border-gray-200">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50 border-b border-gray-200">
                <tr>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase w-8"></th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Product</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Category</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Price</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Stock</th>
                  <th className="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {filteredItemMgmtProducts.map((product) => {
                  const variations = productVariations[product.id] || [];
                  const hasVariations = (product.variationCount || 0) > 0;
                  const isExpanded = expandedProducts.has(product.id);
                  const isLoadingVariations = loadingVariations.has(product.id);
                  
                  return (
                    <React.Fragment key={product.id}>
                      <tr className="hover:bg-gray-50">
                        <td className="px-4 py-3">
                          {hasVariations && (
                            <button
                              onClick={() => toggleProductExpansion(product.id)}
                              className="p-1 hover:bg-gray-200 rounded transition"
                            >
                              {isExpanded ? (
                                <ChevronDown className="h-4 w-4 text-gray-600" />
                              ) : (
                                <ChevronRight className="h-4 w-4 text-gray-600" />
                              )}
                            </button>
                          )}
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-3">
                            {product.imageUrl && (
                              <img src={product.imageUrl} alt={product.name} className="w-10 h-10 rounded object-cover" />
                            )}
                            <div className="flex items-center gap-2">
                              <div className="text-sm font-medium text-gray-900">{product.name}</div>
                              {/* Variation badge removed as requested */}
                            </div>
                          </div>
                        </td>
                        <td className="px-4 py-3">
                          <span className="text-sm text-gray-600">{product.categoryName || 'N/A'}</span>
                        </td>
                        <td className="px-4 py-3">
                          <span className="text-sm font-medium text-gray-900">{(product.price || 0).toFixed(2)}</span>
                        </td>
                        <td className="px-4 py-3">
                          <span className="text-sm text-gray-900">{product.inStock || 0}</span>
                        </td>
                        <td className="px-4 py-3">
                          <div className="flex items-center gap-2">
                            {/* Active Toggle */}
                            <label className="inline-flex items-center select-none cursor-pointer" role="switch" aria-checked={!!product.isActive}>
                              <input
                                type="checkbox"
                                className="sr-only peer"
                                checked={!!product.isActive}
                                onChange={(e) => handleToggleActive(product.id, e.target.checked)}
                              />
                              <div
                                className="relative w-11 h-6 rounded-full bg-gray-300 transition-colors duration-200 ease-in-out peer-checked:bg-teal-600
                                           after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:w-5 after:h-5 after:bg-white after:rounded-full after:shadow
                                           after:transform after:transition-transform after:duration-200 after:ease-in-out peer-checked:after:translate-x-5"
                              />
                            </label>
                            {/* Edit Button */}
                            <button
                              onClick={() => handleItemEdit(product)}
                              className="px-4 py-1.5 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                            >
                              Edit
                            </button>
                          </div>
                        </td>
                      </tr>
                      
                      {/* Expanded Variation Rows */}
                      {isExpanded && (
                        <tr>
                          <td colSpan={6} className="px-4 py-4 bg-gray-50">
                            {isLoadingVariations ? (
                              <div className="flex justify-center py-4">
                                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                              </div>
                            ) : (
                              <div className="ml-12">
                                <h4 className="text-xs font-semibold text-gray-700 uppercase mb-3">Product Variations</h4>
                                <div className="space-y-2">
                                  {variations.map((variation) => (
                                    <div key={variation.id} className="bg-white rounded-lg border border-gray-200 p-3">
                                      <div className="grid grid-cols-6 gap-4 items-center">
                                        <div className="col-span-2 flex items-center gap-3">
                                          {variation.imageURL && (
                                            <img src={variation.imageURL} alt={variation.name} className="w-10 h-10 rounded object-cover" />
                                          )}
                                          <div>
                                            <div className="text-sm font-medium text-gray-900">{variation.name || 'Unnamed Variation'}</div>
                                            <div className="text-xs text-gray-500">SKU: {variation.SKU || variation.sku || 'N/A'}</div>
                                          </div>
                                        </div>
                                        <div>
                                          <div className="text-xs text-gray-500">Price</div>
                                          <div className="text-sm font-medium text-gray-900">{(variation.price || 0).toFixed(2)}</div>
                                        </div>
                                        <div>
                                          <div className="text-xs text-gray-500">Stock</div>
                                          <div className="text-sm text-gray-900">{variation.stock || 0}</div>
                                        </div>
                                        <div>
                                          <div className="text-xs text-gray-500">Dimensions</div>
                                          <div className="text-xs text-gray-900">
                                            {variation.dimensions?.length && variation.dimensions?.width && variation.dimensions?.height
                                              ? `${variation.dimensions.length}${variation.dimensions.width}${variation.dimensions.height} ${variation.dimensionsUnit || 'cm'}`
                                              : 'N/A'}
                                          </div>
                                        </div>
                                        <div>
                                          <div className="text-xs text-gray-500">Weight</div>
                                          <div className="text-xs text-gray-900">
                                            {variation.weight ? `${variation.weight} ${variation.weightUnit || 'kg'}` : 'N/A'}
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </td>
                        </tr>
                      )}
                    </React.Fragment>
                  );
                })}
              </tbody>
            </table>
          </div>

          {filteredItemMgmtProducts.length === 0 && (
            <div className="text-center py-12">
              <Package className="mx-auto h-12 w-12 text-gray-400" />
              <p className="mt-2 text-sm text-gray-500">No products found</p>
            </div>
          )}
        </div>

        {/* Edit Product Modal */}
        {showEditModal && editForm && (
          <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
            <div className="absolute inset-0 bg-black/60" onClick={() => !submitting && setShowEditModal(false)} />
            <div className="relative bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
              {/* Modal Header */}
              <div className="sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 rounded-t-2xl">
                <div className="flex items-center justify-between">
                  <h2 className="text-xl font-bold text-white">Edit Product</h2>
                  <button
                    onClick={() => !submitting && setShowEditModal(false)}
                    className="text-white/80 hover:text-white transition"
                  >
                    <X className="w-6 h-6" />
                  </button>
                </div>
              </div>

              <input
                ref={editImageInputRef}
                type="file"
                accept="image/*"
                className="hidden"
                onChange={(e) => {
                  const file = e.target.files?.[0];
                  if (file) {
                    const preview = URL.createObjectURL(file);
                    setEditForm(prev => prev ? {
                      ...prev,
                      imageFile: file,
                      imagePreview: preview
                    } : null);
                  }
                }}
              />

              {/* Modal Body */}
              <div className="p-6 space-y-6">
                {/* Basic Information Section */}
                <div className="bg-gray-50 rounded-xl p-5 border border-gray-200">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <Package className="w-5 h-5 text-blue-600" />
                    Basic Information
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Product Name *</label>
                      <input
                        type="text"
                        value={editForm.name}
                        onChange={(e) => setEditForm({...editForm, name: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter product name"
                      />
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Description</label>
                      <textarea
                        value={editForm.description}
                        onChange={(e) => setEditForm({...editForm, description: e.target.value})}
                        rows={3}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Enter product description"
                      />
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700 mb-2">Product Image</label>
                      <div className="flex items-center gap-4">
                        {(editForm.imagePreview || editForm.imageURL) && (
                          <img
                            src={editForm.imagePreview || editForm.imageURL}
                            alt="Product"
                            className="w-24 h-24 rounded-lg object-cover border-2 border-gray-200"
                          />
                        )}
                        <button
                          type="button"
                          onClick={() => editImageInputRef.current?.click()}
                          className="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium"
                        >
                          {editForm.imageURL ? 'Change Image' : 'Upload Image'}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                {/* Category & Classification Section */}
                <div className="bg-gray-50 rounded-xl p-5 border border-gray-200">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <FolderTree className="w-5 h-5 text-green-600" />
                    Category & Classification
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                      <select
                        value={editForm.categoryID}
                        onChange={(e) => {
                          setEditForm({...editForm, categoryID: e.target.value, subCategoryID: ''});
                          if (e.target.value) {
                            CategoryService.listenSubcategories(e.target.value, setSubcategoryOptions);
                          }
                        }}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        <option value="">Select category</option>
                        {categoriesList.map((cat) => (
                          <option key={cat.id} value={cat.id}>{cat.name}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Subcategory</label>
                      <select
                        value={editForm.subCategoryID}
                        onChange={(e) => setEditForm({...editForm, subCategoryID: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        disabled={!editForm.categoryID}
                      >
                        <option value="">Select subcategory</option>
                        {subcategoryOptions.map((sub) => (
                          <option key={sub.id} value={sub.id}>{sub.name}</option>
                        ))}
                      </select>
                    </div>
                  </div>
                </div>

                {/* Variations Section */}
                <div className="bg-gray-50 rounded-xl p-5 border border-gray-200">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                      <Package className="w-5 h-5 text-purple-600" />
                      Product Variations
                    </h3>
                    <button
                      type="button"
                      onClick={() => {
                        setEditForm(prev => prev ? {
                          ...prev,
                          variations: [...prev.variations, {
                            name: '',
                            SKU: '',
                            price: 0,
                            stock: 0,
                            imageURL: '',
                            imageFile: null,
                            imagePreview: null,
                            weight: '',
                            weightUnit: 'kg',
                            dimensions: { length: '', width: '', height: '' },
                            dimensionsUnit: 'cm',
                            isFragile: false,
                            isNew: true,
                            isDeleted: false
                          }]
                        } : null);
                      }}
                      className="px-3 py-1.5 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition flex items-center gap-1"
                    >
                      <Plus className="w-4 h-4" />
                      Add Variation
                    </button>
                  </div>
                  
                  {editForm.variations.filter(v => !v.isDeleted).length === 0 ? (
                    <div className="text-center py-6 text-gray-500 text-sm">
                      No variations added. Click "Add Variation" to create one.
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {editForm.variations.map((variation, index) => {
                        if (variation.isDeleted) return null;
                        const displayImage = variation.imagePreview || variation.imageURL;
                        return (
                          <div key={index} className="bg-white rounded-lg border-2 border-purple-200 p-5 shadow-sm">
                            <div className="flex items-start justify-between mb-4">
                              <h4 className="text-base font-semibold text-gray-800 flex items-center gap-2">
                                <span className="inline-flex items-center justify-center w-6 h-6 rounded-full bg-purple-100 text-purple-600 text-xs font-bold">
                                  {index + 1}
                                </span>
                                Variation {index + 1}
                              </h4>
                              <button
                                type="button"
                                onClick={() => {
                                  setEditForm(prev => {
                                    if (!prev) return null;
                                    const updatedVariations = [...prev.variations];
                                    if (variation.isNew) {
                                      updatedVariations.splice(index, 1);
                                    } else {
                                      updatedVariations[index] = { ...updatedVariations[index], isDeleted: true };
                                    }
                                    return { ...prev, variations: updatedVariations };
                                  });
                                }}
                                className="text-red-600 hover:text-red-700 hover:bg-red-50 p-1.5 rounded-lg transition"
                              >
                                <X className="w-5 h-5" />
                              </button>
                            </div>
                            
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-5">
                              {/* Left Column - Image */}
                              <div className="lg:col-span-1">
                                <label className="block text-sm font-medium text-gray-700 mb-2">Variation Image</label>
                                <div className="relative">
                                  <input
                                    ref={(el) => { variationImageInputRefs.current[index] = el; }}
                                    type="file"
                                    accept="image/*"
                                    className="hidden"
                                    onChange={(e) => {
                                      const file = e.target.files?.[0];
                                      if (file) {
                                        const preview = URL.createObjectURL(file);
                                        setEditForm(prev => {
                                          if (!prev) return null;
                                          const updated = [...prev.variations];
                                          updated[index] = {
                                            ...updated[index],
                                            imageFile: file,
                                            imagePreview: preview
                                          };
                                          return { ...prev, variations: updated };
                                        });
                                      }
                                    }}
                                  />
                                  {displayImage ? (
                                    <div className="relative group">
                                      <img
                                        src={displayImage}
                                        alt={variation.name || 'Variation'}
                                        className="w-full h-32 object-cover rounded-lg border-2 border-gray-200"
                                      />
                                      <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition rounded-lg flex items-center justify-center gap-2">
                                        <button
                                          type="button"
                                          onClick={() => variationImageInputRefs.current[index]?.click()}
                                          className="px-3 py-1.5 bg-white text-gray-700 rounded-lg text-xs font-medium hover:bg-gray-100 transition"
                                        >
                                          Change
                                        </button>
                                        <button
                                          type="button"
                                          onClick={() => {
                                            setEditForm(prev => {
                                              if (!prev) return null;
                                              const updated = [...prev.variations];
                                              updated[index] = {
                                                ...updated[index],
                                                imageURL: '',
                                                imageFile: null,
                                                imagePreview: null
                                              };
                                              return { ...prev, variations: updated };
                                            });
                                          }}
                                          className="px-3 py-1.5 bg-red-500 text-white rounded-lg text-xs font-medium hover:bg-red-600 transition"
                                        >
                                          Remove
                                        </button>
                                      </div>
                                    </div>
                                  ) : (
                                    <button
                                      type="button"
                                      onClick={() => variationImageInputRefs.current[index]?.click()}
                                      className="w-full h-32 border-2 border-dashed border-gray-300 rounded-lg hover:border-purple-400 hover:bg-purple-50 transition flex flex-col items-center justify-center gap-2 text-gray-500 hover:text-purple-600"
                                    >
                                      <Package className="w-8 h-8" />
                                      <span className="text-xs font-medium">Upload Image</span>
                                    </button>
                                  )}
                                </div>
                              </div>
                              
                              {/* Right Columns - Details */}
                              <div className="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Variation Name</label>
                                  <input
                                    type="text"
                                    value={variation.name}
                                    onChange={(e) => {
                                      setEditForm(prev => {
                                        if (!prev) return null;
                                        const updated = [...prev.variations];
                                        updated[index] = { ...updated[index], name: e.target.value };
                                        return { ...prev, variations: updated };
                                      });
                                    }}
                                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="e.g., Red, Large, Blue"
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">SKU</label>
                                  <input
                                    type="text"
                                    value={variation.SKU}
                                    onChange={(e) => {
                                      setEditForm(prev => {
                                        if (!prev) return null;
                                        const updated = [...prev.variations];
                                        updated[index] = { ...updated[index], SKU: e.target.value };
                                        return { ...prev, variations: updated };
                                      });
                                    }}
                                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="PRODUCT-SKU-001"
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Price ()</label>
                                  <input
                                    type="number"
                                    step="0.01"
                                    value={variation.price}
                                    onChange={(e) => {
                                      setEditForm(prev => {
                                        if (!prev) return null;
                                        const updated = [...prev.variations];
                                        updated[index] = { ...updated[index], price: parseFloat(e.target.value) || 0 };
                                        return { ...prev, variations: updated };
                                      });
                                    }}
                                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="0.00"
                                  />
                                </div>
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Stock</label>
                                  <input
                                    type="number"
                                    value={variation.stock}
                                    onChange={(e) => {
                                      setEditForm(prev => {
                                        if (!prev) return null;
                                        const updated = [...prev.variations];
                                        updated[index] = { ...updated[index], stock: parseInt(e.target.value) || 0 };
                                        return { ...prev, variations: updated };
                                      });
                                    }}
                                    className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    placeholder="0"
                                  />
                                </div>
                                
                                {/* Fragile Checkbox */}
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Fragile</label>
                                  <div className="flex items-center h-10">
                                    <input
                                      type="checkbox"
                                      checked={variation.isFragile ?? false}
                                      onChange={(e) => {
                                        setEditForm(prev => {
                                          if (!prev) return null;
                                          const updated = [...prev.variations];
                                          updated[index] = { ...updated[index], isFragile: e.target.checked };
                                          return { ...prev, variations: updated };
                                        });
                                      }}
                                      className="w-5 h-5 text-purple-600 border-gray-300 rounded focus:ring-purple-500 cursor-pointer accent-purple-600"
                                    />
                                    <span className="ml-2 text-sm text-gray-600">Mark as fragile item</span>
                                  </div>
                                </div>
                                
                                {/* Weight Section */}
                                <div>
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Weight</label>
                                  <div className="flex gap-2">
                                    <input
                                      type="number"
                                      step="0.01"
                                      value={variation.weight}
                                      onChange={(e) => {
                                        setEditForm(prev => {
                                          if (!prev) return null;
                                          const updated = [...prev.variations];
                                          updated[index] = { ...updated[index], weight: e.target.value ? parseFloat(e.target.value) : '' };
                                          return { ...prev, variations: updated };
                                        });
                                      }}
                                      className="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                      placeholder="Enter weight"
                                    />
                                    <select
                                      value={variation.weightUnit}
                                      onChange={(e) => {
                                        setEditForm(prev => {
                                          if (!prev) return null;
                                          const updated = [...prev.variations];
                                          updated[index] = { ...updated[index], weightUnit: e.target.value };
                                          return { ...prev, variations: updated };
                                        });
                                      }}
                                      className="w-20 px-2 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                    >
                                      <option value="g">g</option>
                                      <option value="kg">kg</option>
                                      <option value="lb">lb</option>
                                    </select>
                                  </div>
                                </div>
                                
                                {/* Dimensions Section - Full Width */}
                                <div className="md:col-span-2">
                                  <label className="block text-sm font-medium text-gray-700 mb-2">Dimensions</label>
                                  <div className="grid grid-cols-4 gap-2">
                                    <div className="col-span-1">
                                      <input
                                        type="number"
                                        step="0.01"
                                        value={variation.dimensions.length}
                                        onChange={(e) => {
                                          setEditForm(prev => {
                                            if (!prev) return null;
                                            const updated = [...prev.variations];
                                            updated[index] = {
                                              ...updated[index],
                                              dimensions: { ...updated[index].dimensions, length: e.target.value ? parseFloat(e.target.value) : '' }
                                            };
                                            return { ...prev, variations: updated };
                                          });
                                        }}
                                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Length"
                                      />
                                      <span className="text-xs text-gray-500 mt-1 block">Length</span>
                                    </div>
                                    <div className="col-span-1">
                                      <input
                                        type="number"
                                        step="0.01"
                                        value={variation.dimensions.width}
                                        onChange={(e) => {
                                          setEditForm(prev => {
                                            if (!prev) return null;
                                            const updated = [...prev.variations];
                                            updated[index] = {
                                              ...updated[index],
                                              dimensions: { ...updated[index].dimensions, width: e.target.value ? parseFloat(e.target.value) : '' }
                                            };
                                            return { ...prev, variations: updated };
                                          });
                                        }}
                                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Width"
                                      />
                                      <span className="text-xs text-gray-500 mt-1 block">Width</span>
                                    </div>
                                    <div className="col-span-1">
                                      <input
                                        type="number"
                                        step="0.01"
                                        value={variation.dimensions.height}
                                        onChange={(e) => {
                                          setEditForm(prev => {
                                            if (!prev) return null;
                                            const updated = [...prev.variations];
                                            updated[index] = {
                                              ...updated[index],
                                              dimensions: { ...updated[index].dimensions, height: e.target.value ? parseFloat(e.target.value) : '' }
                                            };
                                            return { ...prev, variations: updated };
                                          });
                                        }}
                                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                        placeholder="Height"
                                      />
                                      <span className="text-xs text-gray-500 mt-1 block">Height</span>
                                    </div>
                                    <div className="col-span-1">
                                      <select
                                        value={variation.dimensionsUnit}
                                        onChange={(e) => {
                                          setEditForm(prev => {
                                            if (!prev) return null;
                                            const updated = [...prev.variations];
                                            updated[index] = { ...updated[index], dimensionsUnit: e.target.value };
                                            return { ...prev, variations: updated };
                                          });
                                        }}
                                        className="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                                      >
                                        <option value="cm">cm</option>
                                        <option value="in">in</option>
                                        <option value="m">m</option>
                                      </select>
                                      <span className="text-xs text-gray-500 mt-1 block">Unit</span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>

                {/* Warranty & Safety Section */}
                <div className="bg-gray-50 rounded-xl p-5 border border-gray-200">
                  <h3 className="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <ShieldCheck className="w-5 h-5 text-purple-600" />
                    Warranty & Safety
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Warranty Type</label>
                      <input
                        type="text"
                        value={editForm.warrantyType}
                        onChange={(e) => setEditForm({...editForm, warrantyType: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., Local Supplier Warranty"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Warranty Duration</label>
                      <input
                        type="text"
                        value={editForm.warrantyDuration}
                        onChange={(e) => setEditForm({...editForm, warrantyDuration: e.target.value})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="e.g., 12 months"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700 mb-2">Dangerous Goods</label>
                      <select
                        value={editForm.dangerousGoods}
                        onChange={(e) => setEditForm({...editForm, dangerousGoods: e.target.value as any})}
                        className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      >
                        <option value="none">None</option>
                        <option value="dangerous">Dangerous</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              {/* Modal Footer */}
              <div className="sticky bottom-0 bg-gray-50 px-6 py-4 rounded-b-2xl border-t border-gray-200 flex justify-end gap-3">
                <button
                  onClick={() => !submitting && setShowEditModal(false)}
                  disabled={submitting}
                  className="px-6 py-2.5 text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium disabled:opacity-50"
                >
                  Cancel
                </button>
                <button
                  onClick={handleItemSave}
                  disabled={submitting}
                  className="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium disabled:opacity-50 flex items-center gap-2"
                >
                  {submitting ? (
                    <>
                      <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                      Saving...
                    </>
                  ) : (
                    'Save Changes'
                  )}
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    );
  }

  // History View Component
  const renderHistoryView = () => (
    <div className="space-y-4">
        {/* Filters */}
        <div className="bg-white border border-gray-200 rounded-lg p-3 flex flex-wrap items-center gap-3 justify-between">
          <DateRangePicker
            value={logsDateRange}
            onChange={setLogsDateRange}
            onApply={() => setLogsPage(1)}
            label="Select date range"
          />
          
          <button
            onClick={exportLogs}
            disabled={filteredLogs.length === 0}
            className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-teal-700 bg-teal-50 border border-teal-200 rounded-lg hover:bg-teal-100 transition disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            Export
          </button>
        </div>

        {/* History Table */}
        <div className="border rounded-lg overflow-hidden bg-white">
          <div className="overflow-x-auto">
            <table className="min-w-full text-xs">
              <thead className="bg-gray-50 border-b">
                <tr>
                  <th className="text-left p-3 font-medium text-gray-600">Timestamp</th>
                  <th className="text-left p-3 font-medium text-gray-600">Item Name</th>
                  <th className="text-left p-3 font-medium text-gray-600">Variant</th>
                  <th className="text-left p-3 font-medium text-gray-600">Account Name</th>
                  <th className="text-left p-3 font-medium text-gray-600">Reason</th>
                  <th className="text-center p-3 font-medium text-gray-600">Adjustment</th>
                  <th className="text-center p-3 font-medium text-gray-600">Stock After</th>
                </tr>
              </thead>
              <tbody>
                {logsLoading && (
                  <>
                    {Array.from({ length: 5 }).map((_, idx) => (
                      <tr key={idx} className="border-b">
                        <td className="p-3"><div className="h-4 bg-gray-200 rounded animate-pulse w-32" /></td>
                        <td className="p-3"><div className="h-4 bg-gray-200 rounded animate-pulse w-40" /></td>
                        <td className="p-3"><div className="h-4 bg-gray-200 rounded animate-pulse w-24" /></td>
                        <td className="p-3"><div className="h-4 bg-gray-200 rounded animate-pulse w-28" /></td>
                        <td className="p-3"><div className="h-4 bg-gray-200 rounded animate-pulse w-48" /></td>
                        <td className="p-3"><div className="h-4 bg-gray-200 rounded animate-pulse w-16" /></td>
                        <td className="p-3"><div className="h-4 bg-gray-200 rounded animate-pulse w-16" /></td>
                      </tr>
                    ))}
                  </>
                )}
                {!logsLoading && paginatedLogs.length === 0 && (
                  <tr>
                    <td colSpan={7} className="p-8 text-center text-gray-500">
                      {logs.length === 0 
                        ? 'No history found. Stock adjustments will appear here.'
                        : 'No history matches your date range.'}
                    </td>
                  </tr>
                )}
                {!logsLoading && paginatedLogs.map((log) => {
                  let timestamp = 'N/A';
                  if (log.at) {
                    const d = new Date(log.at);
                    timestamp = d.toLocaleString(undefined, {
                      year: 'numeric',
                      month: '2-digit',
                      day: '2-digit',
                      hour: '2-digit',
                      minute: '2-digit',
                    });
                  }
                  
                  const itemName = log.productName || 'Unknown';
                  const variant = log.before?.variationName || log.after?.variationName || 'N/A';
                  const accountName = log.userName || log.userId || 'Unknown';
                  const reason = log.detail || 'N/A';
                  
                  let adjustment = 'N/A';
                  let stockAfter = 'N/A';
                  if (log.action === 'adjust_stock') {
                    const before = log.before?.stock || 0;
                    const after = log.after?.stock || 0;
                    const delta = after - before;
                    adjustment = delta >= 0 ? `+${delta}` : `${delta}`;
                    stockAfter = after.toString();
                  }
                  
                  return (
                    <tr key={log.id} className="border-b hover:bg-gray-50">
                      <td className="p-3 text-gray-700">{timestamp}</td>
                      <td className="p-3 text-gray-900 font-medium">{itemName}</td>
                      <td className="p-3 text-gray-700">{variant}</td>
                      <td className="p-3 text-gray-700">{accountName}</td>
                      <td className="p-3 text-gray-600 text-xs">{reason}</td>
                      <td className="p-3 text-center">
                        {adjustment !== 'N/A' && (
                          <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                            adjustment.startsWith('+') ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                          }`}>
                            {adjustment}
                          </span>
                        )}
                        {adjustment === 'N/A' && <span className="text-gray-400">N/A</span>}
                      </td>
                      <td className="p-3 text-center text-gray-900 font-medium">{stockAfter}</td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        </div>

        {/* Pagination */}
        {!logsLoading && totalLogsPages > 1 && (
          <div className="flex items-center justify-between bg-white border border-gray-200 rounded-lg p-3">
            <div className="text-xs text-gray-600">
              Showing {((logsPage - 1) * logsPerPage) + 1} to {Math.min(logsPage * logsPerPage, filteredLogs.length)} of {filteredLogs.length}
            </div>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setLogsPage(p => Math.max(1, p - 1))}
                disabled={logsPage === 1}
                className="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed"
              >
                Previous
              </button>
              <div className="text-xs text-gray-600">
                Page {logsPage} of {totalLogsPages}
              </div>
              <button
                onClick={() => setLogsPage(p => Math.min(totalLogsPages, p + 1))}
                disabled={logsPage === totalLogsPages}
                className="px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed"
              >
                Next
              </button>
            </div>
          </div>
        )}
      </div>
    );
  };

  // All Products View (Catalog) Component  
  const renderAllView = () => (
    <div className="space-y-8">
      <div className="flex flex-wrap gap-2 border-b border-gray-200 pb-2">
        {[
          { key: 'all', label: 'All' },
          { key: 'active', label: 'Active' },
          { key: 'inactive', label: 'Inactive' },
          { key: 'draft', label: 'Draft' },
          { key: 'pending_qc', label: 'Pending QC' },
          { key: 'violation', label: 'Violation' },
          { key: 'deleted', label: 'Archive' },
        ].map(t => (
          <button
            key={t.key}
            className={`relative px-3 py-1.5 text-sm font-medium rounded ${catalogTab === t.key ? 'bg-teal-50 text-teal-700 border border-teal-200' : 'text-gray-600 hover:bg-gray-50 border border-transparent'}`}
            onClick={() => setCatalogTab(t.key as any)}
          >
            {t.label}
            {t.key === 'active' && statusCounts.active > 0 && (
              <span className="absolute -top-2 -right-2 inline-flex items-center justify-center h-5 min-w-5 px-1.5 rounded-full bg-teal-600 text-white text-[10px] leading-none shadow ring-2 ring-white">
                {statusCounts.active}
              </span>
            )}
            {t.key === 'inactive' && statusCounts.inactive > 0 && (
              <span className="absolute -top-2 -right-2 inline-flex items-center justify-center h-5 min-w-5 px-1.5 rounded-full bg-gray-500 text-white text-[10px] leading-none shadow ring-2 ring-white">
                {statusCounts.inactive}
              </span>
            )}
          </button>
        ))}
      </div>

      <div className="flex flex-wrap gap-3 items-center">
        <input
          value={filterName}
          onChange={(e) => setFilterName(e.target.value)}
          placeholder="Filter by product name"
          className="w-64 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
        />
        <select
          value={filterCategory}
          onChange={(e) => setFilterCategory(e.target.value)}
          className="w-48 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
        >
          <option value="">All categories</option>
          {CATEGORY_OPTIONS.map((c) => (
            <option key={c} value={c}>{c}</option>
          ))}
        </select>
        <select
          value={sortBy}
          onChange={(e) => setSortBy(e.target.value as any)}
          className="w-48 max-w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
        >
          <option value="name">Sort by: Name</option>
          <option value="stock">Sort by: Stock (desc)</option>
          <option value="stockAsc">Sort by: Stock (asc)</option>
          <option value="updatedAt">Sort by: Updated</option>
        </select>
        <label className="inline-flex items-center gap-2 text-sm text-gray-700">
          <input type="checkbox" className="accent-teal-600" checked={lowOnly} onChange={(e)=> setLowOnly(e.target.checked)} />
          Low stock only
        </label>
        
        <div className="flex-1" />
    
      </div>

      {/* KPI metrics for inventory alerts */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
        <div className="rounded-xl border border-red-200 bg-red-50 p-4 flex items-center gap-3">
          <div className="p-2 rounded-lg bg-red-100 text-red-700"><CircleSlash className="w-5 h-5" /></div>
          <div>
            <div className="text-xs text-red-700">Out of stock</div>
            <div className="text-xl font-semibold text-red-800">{stockSummary.out}</div>
          </div>
        </div>
        <div className="rounded-xl border border-amber-200 bg-amber-50 p-4 flex items-center gap-3">
          <div className="p-2 rounded-lg bg-amber-100 text-amber-700"><AlertTriangle className="w-5 h-5" /></div>
          <div>
            <div className="text-xs text-amber-700">Low stock</div>
            <div className="text-xl font-semibold text-amber-800">{stockSummary.low}</div>
          </div>
        </div>
      </div>

      {/* Catalog Table */}
      <CatalogTable
        items={filteredCatalog}
        tabKey={catalogTab}
        onToggleActive={async (id, next) => {
          await ProductService.toggleActive(id, next);
        }}
        onRestore={async (item) => {
          try {
            await ProductService.restore(item.id);
            setCatalogTab('inactive');
            toast({ title: 'Product restored', description: 'Moved to Inactive tab. Toggle to activate when ready.' });
          } catch (e) {
            console.error('Restore failed', e);
            toast({ title: 'Failed to restore', description: 'Please try again.' });
          }
        }}
      />

      {/* Delete Confirmation Dialog */}
      {deleteDialogOpen && deleteTarget && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/40" onClick={() => setDeleteDialogOpen(false)} />
          <div className="relative bg-white rounded-lg shadow-xl w-full max-w-md p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-1">Delete product</h3>
            <p className="text-xs text-gray-600 mb-4">Are you sure you want to delete this product? It will be moved to the Archive tab and can be restored later.</p>
            <div className="p-3 border rounded-lg bg-gray-50 mb-4">
              <div className="text-xs text-gray-500 mb-1">Product</div>
              <div className="text-sm font-medium text-gray-900">{deleteTarget.name}</div>
            </div>
            <div className="mt-6 flex justify-end gap-3">
              <button className="px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800" onClick={() => setDeleteDialogOpen(false)}>Cancel</button>
              <button
                className="px-3 py-2 text-sm font-medium bg-red-600 text-white rounded-lg hover:bg-red-700"
                onClick={async () => {
                  try {
                    await ProductService.markDeleted(deleteTarget.id);
                    setDeleteDialogOpen(false);
                    setDeleteTarget(null);
                    setCatalogTab('deleted');
                    toast({ title: 'Product deleted', description: 'Moved to Archive tab.' });
                  } catch (e) {
                    console.error('Delete failed', e);
                    toast({ title: 'Failed to delete', description: 'Please try again.' });
                  }
                }}
              >
                Yes, delete
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Edit Price Dialog */}
      {priceDialogOpen && priceEditingItem && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/40" onClick={() => !submitting && setPriceDialogOpen(false)} />
          <div className="relative bg-white rounded-lg shadow-xl w-full max-w-lg p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-1">Edit Price</h3>
            <p className="text-xs text-gray-500 mb-4">Update retail and discount price. Optionally schedule a promotion.</p>
            <div className="space-y-4">
              <div className="p-3 border rounded-lg bg-gray-50">
                <div className="text-xs text-gray-500 mb-1">Product</div>
                <div className="text-sm font-medium text-gray-900">{priceEditingItem.name}</div>
              </div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Retail Price</label>
                  <input type="number" value={priceForm.price} onChange={(e)=> setPriceForm(s=> ({...s, price: e.target.value === '' ? '' : Number(e.target.value)}))} className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Discount Price</label>
                  <div className="flex items-center gap-2">
                    <input type="number" value={priceForm.specialPrice} onChange={(e)=> setPriceForm(s=> ({...s, specialPrice: e.target.value === '' ? '' : Number(e.target.value)}))} className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" />
                    <button type="button" className="p-2 rounded border border-gray-200 hover:bg-gray-50" title="Promotion schedule" onClick={()=> setPriceForm(s=> ({...s, promoMode: s.promoMode === 'long' ? 'dated' : 'long'}))}>
                      <CalendarClock className="w-4 h-4 text-gray-600" />
                    </button>
                  </div>
                </div>
              </div>
              {priceForm.promoMode === 'dated' && (
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">Start Date</label>
                    <input type="date" value={priceForm.start || ''} onChange={(e)=> setPriceForm(s=> ({...s, start: e.target.value}))} className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" />
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">End Date</label>
                    <input type="date" value={priceForm.end || ''} onChange={(e)=> setPriceForm(s=> ({...s, end: e.target.value}))} className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent" />
                  </div>
                </div>
              )}
            </div>
            <div className="mt-6 flex justify-end gap-3">
              <button className="px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800" onClick={()=> setPriceDialogOpen(false)} disabled={submitting}>Cancel</button>
              <button className="px-3 py-2 text-sm font-medium bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-40" onClick={savePriceDialog} disabled={submitting}>Save</button>
            </div>
          </div>
        </div>
      )}

      {/* Edit Stock Dialog */}
      {stockDialogOpen && stockEditingItem && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/40" onClick={() => !submitting && setStockDialogOpen(false)} />
          <div className="relative bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
            <h3 className="text-lg font-semibold text-gray-900 mb-1">Adjust Stock</h3>
            <p className="text-xs text-gray-500 mb-4">Increase or decrease available stock per variation.</p>
            <div className="space-y-4">
              <div className="p-3 border rounded-lg bg-gray-50">
                <div className="flex items-center gap-3">
                  {stockEditingItem.imageUrl ? (
                    <img src={stockEditingItem.imageUrl} alt={stockEditingItem.name} className="h-10 w-10 rounded object-cover border" />
                  ) : (
                    <div className="h-10 w-10 rounded bg-gray-100 border" />
                  )}
                  <div>
                    <div className="text-sm font-medium text-gray-900">{stockEditingItem.name}</div>
                    <div className="text-xs text-gray-500">Total stock (all variations): <span className="font-semibold text-gray-700">{stockEditingItem.inStock}</span></div>
                  </div>
                </div>
              </div>

              {/* Variations table */}
              <div className="overflow-auto border rounded">
                <table className="min-w-full text-xs">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="text-left p-2 font-medium text-gray-600">Image</th>
                      <th className="text-left p-2 font-medium text-gray-600">Product</th>
                      <th className="text-right p-2 font-medium text-gray-600">Current Stock</th>
                      <th className="text-right p-2 font-medium text-gray-600">Delta</th>
                      <th className="text-left p-2 font-medium text-gray-600">Reason</th>
                    </tr>
                  </thead>
                  <tbody>
                    {stockRows.map((row) => (
                      <tr key={row.id} className="border-t">
                        <td className="p-2">
                          {stockEditingItem.imageUrl ? (
                            <img src={stockEditingItem.imageUrl} alt={stockEditingItem.name} className="h-8 w-8 rounded object-cover border" />
                          ) : (
                            <div className="h-8 w-8 rounded bg-gray-100 border" />
                          )}
                        </td>
                        <td className="p-2">
                          <div className="text-gray-900 font-medium">{stockEditingItem.name}</div>
                          <div className="text-[11px] text-gray-500">Variant: {row.name || 'default'}</div>
                        </td>
                        <td className="p-2 text-right">{row.stock}</td>
                        <td className="p-2 text-right">
                          <input
                            type="number"
                            value={row.delta}
                            onChange={(e)=> {
                              const v = e.target.value === '' ? '' : Number(e.target.value);
                              setStockRows(list => list.map(r => r.id === row.id ? { ...r, delta: v } : r));
                            }}
                            placeholder="e.g. +5 or -2"
                            className="w-24 p-1 border rounded text-right"
                          />
                        </td>
                        <td className="p-2">
                          <select
                            value={row.reason}
                            onChange={(e)=> setStockRows(list => list.map(r => r.id === row.id ? { ...r, reason: e.target.value } : r))}
                            className="w-full p-1 border rounded"
                          >
                            <option value="">Select reason</option>
                            {['Restock','Correction','Damage','Expiration','Return'].map(r => (
                              <option key={r} value={r}>{r}</option>
                            ))}
                          </select>
                        </td>
                      </tr>
                    ))}
                    {stockRows.length === 0 && (
                      <tr>
                        <td colSpan={5} className="p-4 text-center text-gray-500">No variations found.</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>

              <div className="mt-4 flex justify-end gap-3">
                <button className="px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800" onClick={() => setStockDialogOpen(false)} disabled={submitting}>Cancel</button>
                <button
                  className="px-3 py-2 text-sm font-medium bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-40"
                  onClick={saveStockDialog}
                  disabled={submitting || stockRows.every(r => r.delta === '' || Number(r.delta) === 0 || !r.reason)}
                >
                  Save
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Add/Edit Product Modal */}
      {showAdd && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          <div className="absolute inset-0 bg-black/40" onClick={() => !submitting && (setShowAdd(false), setEditingId(null))} />
          <div className="relative bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
            <h3 className="text-lg font-semibold text-gray-900">{editingId ? 'Edit Product' : 'Add Product'}</h3>
            <p className="text-sm text-gray-500 mb-4">{editingId ? 'Update the product details.' : 'Create a new inventory item.'}</p>
            <div className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Product Name</label>
                  <input
                    value={newItem.name}
                    onChange={(e) => setNewItem((s) => ({ ...s, name: e.target.value }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="e.g. Alginate Powder"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">SKU</label>
                  <input
                    value={newItem.sku}
                    onChange={(e) => setNewItem((s) => ({ ...s, sku: e.target.value }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="e.g. SKU-ALG-001"
                  />
                </div>
              </div>

              <div>
                <label className="block text-xs font-medium text-gray-600 mb-1">Description</label>
                <textarea
                  value={newItem.description}
                  onChange={(e) => setNewItem((s) => ({ ...s, description: e.target.value }))}
                  className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                  rows={3}
                  placeholder="Short product description"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Product Image</label>
                  <div className="flex items-center gap-3">
                    <input ref={fileInputRef} type="file" accept="image/*" className="hidden" onChange={handleFileChange} />
                    <button
                      type="button"
                      onClick={handlePickImage}
                      className="px-3 py-2 text-sm font-medium bg-gray-100 rounded-lg hover:bg-gray-200"
                      disabled={!effectiveSellerId}
                    >
                      {(newItem.imagePreview || newItem.imageUrl) ? 'Replace Image' : 'Add Image'}
                    </button>
                    {(newItem.imagePreview || newItem.imageUrl) && (
                      <img src={newItem.imagePreview || newItem.imageUrl} alt="preview" className="h-10 w-10 rounded object-cover border" />
                    )}
                  </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">Category</label>
                    <select
                      value={newItem.category}
                      onChange={(e) => setNewItem((s) => ({ ...s, category: e.target.value, subcategory: '' }))}
                      className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    >
                      <option value="">Select category...</option>
                      {CATEGORY_OPTIONS.map((c) => (
                        <option key={c} value={c}>{c}</option>
                      ))}
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-medium text-gray-600 mb-1">Subcategory</label>
                    <select
                      value={newItem.subcategory}
                      onChange={(e) => setNewItem((s) => ({ ...s, subcategory: e.target.value }))}
                      className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                      disabled={!newItem.category}
                    >
                      <option value="">Select subcategory...</option>
                      {(newItem.category ? SUBCATEGORY_OPTIONS[newItem.category as typeof CATEGORY_OPTIONS[number]] : []).map((sc) => (
                        <option key={sc} value={sc}>{sc}</option>
                      ))}
                    </select>
                  </div>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Price</label>
                  <input
                    type="number"
                    value={newItem.price}
                    onChange={(e) => setNewItem((s) => ({ ...s, price: Number(e.target.value) }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="0.00"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Weight</label>
                  <input
                    type="number"
                    value={newItem.weight}
                    onChange={(e) => setNewItem((s) => ({ ...s, weight: Number(e.target.value) }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Unit</label>
                  <input
                    value={newItem.unit}
                    onChange={(e) => setNewItem((s) => ({ ...s, unit: e.target.value }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="pcs, box"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Length</label>
                  <input
                    type="number"
                    value={newItem.dimensions.length}
                    onChange={(e) => setNewItem((s) => ({ ...s, dimensions: { ...s.dimensions, length: Number(e.target.value) } }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Width</label>
                  <input
                    type="number"
                    value={newItem.dimensions.width}
                    onChange={(e) => setNewItem((s) => ({ ...s, dimensions: { ...s.dimensions, width: Number(e.target.value) } }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Height</label>
                  <input
                    type="number"
                    value={newItem.dimensions.height}
                    onChange={(e) => setNewItem((s) => ({ ...s, dimensions: { ...s.dimensions, height: Number(e.target.value) } }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Suggested Threshold</label>
                  <input
                    type="number"
                    value={newItem.suggestedThreshold}
                    onChange={(e) => setNewItem((s) => ({ ...s, suggestedThreshold: Number(e.target.value) }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
                <div>
                  <label className="block text-xs font-medium text-gray-600 mb-1">Initial Stock</label>
                  <input
                    type="number"
                    value={newItem.inStock}
                    onChange={(e) => setNewItem((s) => ({ ...s, inStock: Number(e.target.value) }))}
                    className="w-full text-sm p-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-transparent"
                    placeholder="0"
                  />
                </div>
                <div className="hidden md:block"/>
              </div>

              {/* Price, Stock & Variants */}
              <div className="mt-6">
                <div className="flex items-center justify-between mb-2">
                  <div>
                    <h4 className="text-sm font-semibold text-gray-900">Price, Stock & Variants</h4>
                    <p className="text-xs text-gray-500">Add variant rows to set per-variant price and stock.</p>
                  </div>
                  <div className="flex items-center gap-2">
                    <button
                      type="button"
                      className="text-xs px-3 py-1 rounded border border-gray-300 hover:bg-gray-50"
                      onClick={addBlankVariant}
                    >
                      + Add Variant
                    </button>
                  </div>
                </div>

                {variants.length === 0 && (
                  <div className="border rounded overflow-hidden">
                    <div className="grid grid-cols-7 text-xs bg-gray-50">
                      <div className="p-2 font-medium text-gray-600">Image</div>
                      <div className="p-2 font-medium text-gray-600">Name</div>
                      <div className="p-2 font-medium text-gray-600">Price</div>
                      <div className="p-2 font-medium text-gray-600">Special Price</div>
                      <div className="p-2 font-medium text-gray-600">Stock</div>
                      <div className="p-2 font-medium text-gray-600">SellerSKU</div>
                      <div className="p-2 font-medium text-gray-600">Availability</div>
                    </div>
                    <div className="grid grid-cols-7 items-center text-xs">
                      <div className="p-2">
                        <button
                          type="button"
                          className="text-xs px-3 py-1 rounded border border-gray-300 hover:bg-gray-50"
                          onClick={handlePickImage}
                          title="Choose product image"
                          disabled={!effectiveSellerId}
                        >
                          {(newItem.imagePreview || newItem.imageUrl) ? 'Replace Image' : 'Add Image'}
                        </button>
                        {(newItem.imagePreview || newItem.imageUrl) && (
                          <img src={newItem.imagePreview || newItem.imageUrl} alt="preview" className="inline-block ml-2 h-8 w-8 rounded object-cover border" />
                        )}
                      </div>
                      <div className="p-2"><input value={newItem.simpleVariantName || ''} onChange={(e)=> setNewItem(s=> ({...s, simpleVariantName: e.target.value}))} className="w-full p-1 border rounded" placeholder="e.g. default" /></div>
                      <div className="p-2"><input type="number" value={newItem.price} onChange={(e)=> setNewItem(s=> ({...s, price: Number(e.target.value)}))} className="w-full p-1 border rounded" /></div>
                      <div className="p-2"><input type="number" value={newItem.specialPrice} onChange={(e)=> setNewItem(s=> ({...s, specialPrice: Number(e.target.value)}))} className="w-full p-1 border rounded" /></div>
                      <div className="p-2"><input type="number" value={newItem.inStock} onChange={(e)=> setNewItem(s=> ({...s, inStock: Number(e.target.value)}))} className="w-full p-1 border rounded" /></div>
                      <div className="p-2"><input value={newItem.sku} onChange={(e)=> setNewItem(s=> ({...s, sku: e.target.value}))} className="w-full p-1 border rounded" /></div>
                      <div className="p-2"><input type="checkbox" className="accent-teal-600" checked={available} onChange={(e)=> setAvailable(e.target.checked)} /></div>
                    </div>
                  </div>
                )}

                {/* Variants grid (manual) */}
                {variants.length > 0 && (
                  <div className="mt-4 overflow-auto border rounded">
                    <table className="min-w-full text-xs">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="text-left p-2 font-medium text-gray-600">Image</th>
                          <th className="text-left p-2 font-medium text-gray-600">Name</th>
                          <th className="text-left p-2 font-medium text-gray-600">Price</th>
                          <th className="text-left p-2 font-medium text-gray-600">Special Price</th>
                          <th className="text-left p-2 font-medium text-gray-600">Stock</th>
                          <th className="text-left p-2 font-medium text-gray-600">SellerSKU</th>
                          <th className="text-left p-2 font-medium text-gray-600">Availability</th>
                          <th className="text-left p-2 font-medium text-gray-600">Fragile</th>
                        </tr>
                      </thead>
                      <tbody>
                        {variants.map((v, idx) => (
                          <tr key={v.key} className={idx % 2 ? 'bg-white' : 'bg-gray-50'}>
                            <td className="p-2">
                              <input
                                type="file"
                                accept="image/*"
                                ref={(el) => { variantFileInputs.current[v.key] = el; }}
                                className="hidden"
                                onChange={(e) => handleVariantFileChange(v.key, e)}
                              />
                              <button
                                type="button"
                                className="px-2 py-1 rounded bg-gray-100 hover:bg-gray-200"
                                onClick={() => triggerVariantFilePick(v.key)}
                                disabled={!effectiveSellerId}
                              >
                                {(v.imagePreview || v.imageUrl) ? 'Replace' : 'Add Image'}
                              </button>
                              {(v.imagePreview || v.imageUrl) && (
                                <img src={v.imagePreview || v.imageUrl} alt="variant" className="inline-block ml-2 h-8 w-8 rounded object-cover border" />
                              )}
                            </td>
                            <td className="p-2">
                              <input value={v.name || ''} onChange={(e)=> setVariants((list)=> list.map(x=> x.key===v.key?{...x, name: e.target.value}:x))} className="w-full p-1 border rounded" placeholder={`Variant ${idx+1}`} />
                            </td>
                            <td className="p-2">
                              <input type="number" value={v.price} onChange={(e)=> setVariants((list)=> list.map(x=> x.key===v.key?{...x, price: Number(e.target.value)}:x))} className="w-24 p-1 border rounded" />
                            </td>
                            <td className="p-2">
                              <input type="number" value={(v as any).specialPrice || 0} onChange={(e)=> setVariants((list)=> list.map((x)=> x.key===v.key?{...x, specialPrice: Number(e.target.value)}:x))} className="w-24 p-1 border rounded" />
                            </td>
                            <td className="p-2">
                              <input type="number" value={v.stock} onChange={(e)=> setVariants((list)=> list.map(x=> x.key===v.key?{...x, stock: Number(e.target.value)}:x))} className="w-20 p-1 border rounded" />
                            </td>
                            <td className="p-2">
                              <input value={v.sku || ''} onChange={(e)=> setVariants((list)=> list.map(x=> x.key===v.key?{...x, sku: e.target.value}:x))} className="w-32 p-1 border rounded" />
                            </td>
                            <td className="p-2">
                              <input type="checkbox" className="accent-teal-600" checked={(v as any).available ?? true} onChange={(e)=> setVariants((list)=> list.map(x=> x.key===v.key?{...x, available: e.target.checked}:x))} />
                            </td>
                            <td className="p-2">
                              <input type="checkbox" className="accent-teal-600" checked={(v as any).isFragile ?? false} onChange={(e)=> setVariants((list)=> list.map(x=> x.key===v.key?{...x, isFragile: e.target.checked}:x))} />
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
              {/* end Price, Stock & Variants */}
            </div>
            <div className="mt-6 flex justify-end gap-3">
              <button
                className="px-3 py-2 text-sm font-medium text-gray-600 hover:text-gray-800"
                onClick={() => { setShowAdd(false); setEditingId(null); }}
                disabled={submitting}
              >
                Cancel
              </button>
              {/* New: Save as Draft button */}
              <button
                className="px-3 py-2 text-sm font-medium border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-40"
                onClick={() => handleSaveItem('draft')}
                disabled={submitting || !newItem.name.trim()}
                title="Save this product as a draft"
              >
                {submitting ? 'Saving...' : 'Save as Draft'}
              </button>
              <button
                className="px-3 py-2 text-sm font-medium bg-teal-600 text-white rounded-lg hover:bg-teal-700 disabled:opacity-40"
                onClick={() => handleSaveItem()}
                disabled={submitting || !newItem.name.trim()}
              >
                {submitting ? (editingId ? 'Saving...' : 'Creating...') : (editingId ? 'Save' : 'Create')}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );

  // Main return with tab navigation
  return (
    <div className="space-y-6">
      {/* Inventory Control Tab Navigation */}
      <div className="bg-white rounded-lg border border-gray-200 p-1">
        <div className="flex flex-wrap gap-1">
          {[
            { key: 'all', label: 'All', icon: Package },
            { key: 'history', label: 'History', icon: CalendarClock },
            { key: 'stock-adjustment', label: 'Stock Adjustment', icon: Edit },
            { key: 'price-management', label: 'Price Management', icon: CreditCard },
            { key: 'item-management', label: 'Item Management', icon: FolderTree },
          ].map(tab => {
            const Icon = tab.icon;
            const isActive = inventoryControlTab === tab.key;
            return (
              <button
                key={tab.key}
                onClick={() => setInventoryControlTab(tab.key as any)}
                className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium rounded-lg transition-all ${
                  isActive
                    ? 'bg-gradient-to-r from-teal-600 to-teal-700 text-white shadow-md'
                    : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                }`}
              >
                <Icon className="w-4 h-4" />
                {tab.label}
              </button>
            );
          })}
        </div>
      </div>

      {/* Render appropriate view based on selected tab */}
      {inventoryControlTab === 'all' && renderAllView()}
      {inventoryControlTab === 'history' && renderHistoryView()}
      {inventoryControlTab === 'stock-adjustment' && renderStockAdjustmentView()}
      {inventoryControlTab === 'price-management' && renderPriceManagementView()}
      {inventoryControlTab === 'item-management' && renderItemManagementView()}
    </div>
  );
}

export default InventoryTab;
